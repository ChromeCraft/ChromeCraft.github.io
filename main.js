function noise(t,e,i){var r=255&Math.floor(t),n=255&Math.floor(e),a=255&Math.floor(i);t-=Math.floor(t),e-=Math.floor(e),i-=Math.floor(i);var o=fade(t),s=fade(e),h=fade(i),l=p[r]+n,d=p[l]+a,u=p[l+1]+a,c=p[r+1]+n,f=p[c]+a,y=p[c+1]+a;return lerp(h,lerp(s,lerp(o,grad(p[d],t,e,i),grad(p[f],t-1,e,i)),lerp(o,grad(p[u],t,e-1,i),grad(p[y],t-1,e-1,i))),lerp(s,lerp(o,grad(p[d+1],t,e,i-1),grad(p[f+1],t-1,e,i-1)),lerp(o,grad(p[u+1],t,e-1,i-1),grad(p[y+1],t-1,e-1,i-1))))}function lerp(t,e,i){return e+t*(i-e)}function grad(t,e,i,r){var n=15&t,a=8>n?e:i,o=4>n?i:12==n||14==n?e:r;return(0==(1&n)?a:-a)+(0==(2&n)?o:-o)}function fade(t){return t*t*t*(t*(6*t-15)+10)}function pinkNoise(t,e,i,r,n,a){a||(a=.5);for(var o=0,s=1,h=r;h>=n;h/=2)o+=noise(t/h,e/h,i/h)*s,s*=a;return o}function stripes(t,e){var i=.5+.5*Math.sin(2*e*Math.PI*t);return i*i-.5}function turbulence(t,e,i,r){for(var n=-.5;W/12>=r;r*=2)n+=abs(noise(t,e,i,r)/r);return n}function marbled(t,e,i){return.01*stripes(t+2*turbulence(t,e,i,1),1.6)}function crinkled(t,e,i){return-.1*turbulence(t,e,i,1)}function generateBlock(t,e,i,r){var n;if(i<.75+2*noise(23.2*e,938.2*i,28.1*r))n="bedrock";else{var a=pinkNoise(e,i,r+t,32,2)+(2*i/SY-NY)/NY;n=-.2>a?"rock":-.1>a?"dirt":0>a?GRASSY?"dirt":"grass":HY/4>i?"apricot jelly":HY/2>i?"water":"air",Math.pow(noise(e/20+t,i/20,r/20+1e3),3)<-.2&&(n="candy"),Math.pow(noise(e/20,i/20+t,r/20),3)<-.1&&(n="air")}return n}function generateChunk(t,e,i){function r(t,e,i){return s[t+(e<<LOGNX)+(i<<LOGNX+LOGNY)]}function n(t,e){for(var i=NY-1;i>=0;--i){var n=r(t,i,e);if("air"!==n.type)return{iy:i,b:n}}}function a(t,e,i){for(i=i||0;t--;){var a=i+irand(NX-2*i),o=i+irand(NZ-2*i),s=n(a,o);s&&s.iy<NY-1&&BLOCK_TYPES[s.b.type].plantable&&(s=r(a,s.iy+1,o),s.type=e)}}for(var o={key:e+","+i,chunkx:e,chunkz:i,blocks:new Array(NX*NY*NZ),entities:{}},s=o.blocks,h=0,l=0;NZ>l;++l)for(var d=0;NY>d;++d)for(var u=0;NX>u;++u)s[h++]={light:[0,0,0,0],dirtyLight:!1,dirtyGeometry:!1,type:generateBlock(t,u+e,d*SY,l+i)};for(var c=BLOCK_TYPES.soybeans.upon,f=0;NX>f;++f)for(var p=f+e,y=0;NZ>y;++y){var g=y+i;if(2*noise(p/10,9938,g/10)+noise(p/1,9938,g/1)<-.5){var A=n(f,y);A&&A.iy<NY-1&&BLOCK_TYPES[A.b.type][c]&&(r(f,A.iy+1,y).type="soybeans")}}a(4,"flower"),a(6,"weeds");for(var u=0;NX>u;++u)for(var l=0;NZ>l;++l)for(var m=!1,E=NY-1;E>=0;--E){var v=r(u,E,l),T=BLOCK_TYPES[v.type];v.light[3]=T.opaque?0:m?0:LIGHT_SUN,v.dirtyLight=!1,T.luminosity&&(v.dirtyLight=!0),m&&!T.opaque&&(v.dirtyLight=!0),m=m||T.opaque||T.translucent}return o}function irand(t){return Math.floor(Math.random()*t)}function matchRecipie(){for(var t={},e=0;e<CRAFT.length;++e)CRAFT[e]&&(t[CRAFT[e].type]=(t[CRAFT[e].type]||0)+1);for(var e=0;e<RECIPIES.length;++e){var i=RECIPIES[e];if(9===t[i.nine])return i.product}}function reload(){var t=document.getElementsByTagName("head")[0],e=document.createElement("script");e.type="text/javascript",e.src="main.js?"+new Date,e.onload=function(){for(var t in GAME.chunks){var e=GAME.chunks[t];for(var i in e.entities){var r=e.entities[i];r.type=ENTITY_TYPES[r.type.name]}}message("Reloaded")},t.appendChild(e),gl.textures.panorama=loadTexture("panorama.jpg",!0),gl.textures.terrain=loadTexture("terrain.png")}function scale(t,e){for(var i=0;i<t.length;++i)"number"==typeof t[i]?t[i]*=e:scale(t[i],e);return t}function hopEntity(t,e){e=e||1,t.dx=2*tweak()*e,t.dz=2*tweak()*e,t.dy=6*e,t.falling=!0}function initGL(t,e){var i="";try{gl=t.getContext("experimental-webgl",e)||t.getContext("webgl",e),gl&&(gl.viewportWidth=t.width,gl.viewportHeight=t.height)}catch(r){i=r,console.log(i)}return gl?(gl.panorama=new Skybox("skybox","panorama"),gl.sky=new Skybox("skybox","sky"),gl.mainShader=new Shader("main"),gl.particles=new ParticleSystem,gl.textures={panorama:loadTexture("panorama.jpg",!0),terrain:loadTexture("terrain.png")},gl.wireframe=new Wireframe,gl.reticule=new Reticule,gl):void 0}function $(t){return document.getElementById(t)}function getShader(t,e){var i=$(e);if(!i)return null;for(var r="",n=i.firstChild;n;)3==n.nodeType&&(r+=n.textContent),n=n.nextSibling;var a;if("x-shader/x-fragment"==i.type)a=t.createShader(t.FRAGMENT_SHADER);else{if("x-shader/x-vertex"!=i.type)return null;a=t.createShader(t.VERTEX_SHADER)}return t.shaderSource(a,r),t.compileShader(a),t.getShaderParameter(a,t.COMPILE_STATUS)?a:(alert(t.getShaderInfoLog(a)),null)}function Shader(t,e){var i=getShader(gl,t+"-vs"),r=getShader(gl,(e||t)+"-fs");this.program=gl.createProgram(),gl.attachShader(this.program,i),gl.attachShader(this.program,r),gl.linkProgram(this.program),gl.getProgramParameter(this.program,gl.LINK_STATUS)||alert("Could not initialize shaders: "+gl.getProgramInfoLog(this.program)),this.attributes={};for(var n=gl.getProgramParameter(this.program,gl.ACTIVE_ATTRIBUTES),a=0;n>a;++a){var o=gl.getActiveAttrib(this.program,a);this.attributes[o.name]=gl.getAttribLocation(this.program,o.name)}this.uniforms={};for(var s=gl.getProgramParameter(this.program,gl.ACTIVE_UNIFORMS),a=0;s>a;++a){var h=gl.getActiveUniform(this.program,a);this.uniforms[h.name]=gl.getUniformLocation(this.program,h.name)}}function mvPushMatrix(){mvMatrixStack.push(mat4.clone(mvMatrix))}function mvPopMatrix(){if(0==mvMatrixStack.length)throw"Invalid popMatrix!";mvMatrix=mvMatrixStack.pop()}function Chunk(t){var e=t.chunkx,i=t.chunkz;e&=~(NX-1),i&=~(NZ-1),this.chunkx=e,this.chunkz=i,this.blocks=Array(NX*NY*NZ),this.entities={},this.lastUpdate=0,this.nDirty=0,this.opaqueBuffers=new BufferSet,this.translucentBuffers=new BufferSet,GAME.chunks[this.chunkx+","+this.chunkz]=this;var r=t.blocks;r||(r=generateChunk(GAME.seed,this.chunkx,this.chunkz).blocks);for(var n=0;NX*NY*NZ>n;++n){var a=coords(n);a=coords(this.chunkx+a.x,a.y,this.chunkz+a.z),a.data=r[n],this.blocks[n]=new Block(a,this),(this.blocks[n].dirtyLight||this.blocks[n].dirtyGeometry)&&this.nDirty++}if(t.blocks&&!GAME.loading){for(var o=3,s=0;2>s;++s){var h=o+irand(NX-2*o),l=o+irand(NZ-2*o),d=topmost(this.chunkx+h,this.chunkz+l);d&&d.type.plantable&&buildTree(d.neighbor(FACE_TOP))}invalidateEdgesNeighboringChunk(this)}for(var n in t.entities||{})new Entity(t.entities[n])}function pointToAttribute(t,e,i){gl.bindBuffer(gl.ARRAY_BUFFER,e[i]),gl.vertexAttribPointer(t.attributes[i],e[i].itemSize,gl.FLOAT,!1,0,0),gl.bindBuffer(gl.ARRAY_BUFFER,null)}function hDistance(t,e){return Math.sqrt((t.x-e.x)*(t.x-e.x)+(t.z-e.z)*(t.z-e.z))}function distance(t,e){return Math.sqrt((t.x-e.x)*(t.x-e.x)+(t.y-e.y)*(t.y-e.y)+(t.z-e.z)*(t.z-e.z))}function signedHDistanceFromLine(t,e,i){return(i.z-t.z)*Math.sin(e)-(i.x-t.x)*Math.cos(e)}function choice(t){return t||(t=2),Math.floor(Math.random()*t)}function coords(t,e,i){var r;"object"==typeof t?(r="undefined"==typeof t.x?{x:t[0],y:t[1],z:t[2]}:{x:t.x,y:t.y,z:t.z},r.z=Math.floor(r.z),r.y=Math.floor(r.y/SY)*SY,r.x=Math.floor(r.x)):r="undefined"==typeof e?{x:t%NX,y:(t>>LOGNX)%NY*SY,z:(t>>LOGNX+LOGNY)%NZ}:{x:Math.floor(t),y:Math.floor(e/SY)*SY,z:Math.floor(i)},r.chunkx=r.x&~(NX-1),r.chunkz=r.z&~(NZ-1);var n=r.x-r.chunkx,a=r.z-r.chunkz;return r.i=n+(r.y/SY<<LOGNX)+(a<<LOGNX+LOGNY),(r.y<0||r.y>=HY)&&(r.outofbounds=!0),r}function chunk(t,e){return t&=~(NX-1),e&=~(NZ-1),GAME.chunks[t+","+e]}function makeChunk(t,e){t&=~(NX-1),e&=~(NZ-1);var i;return chunk(t,e)||(GEN_STAT.start(),i=new Chunk({chunkx:t,chunkz:e}),invalidateEdgesNeighboringChunk(i),GEN_STAT.end()),i}function invalidateEdgesNeighboringChunk(t){var e=t.chunkx,i=t.chunkz;if(chunk(e-1,i))for(var r=0;NY>r;++r)for(var n=0;NZ>n;++n)block(e-1,r*SY,i+n).invalidateGeometry();if(chunk(e+NX,i))for(var r=0;NY>r;++r)for(var n=0;NZ>n;++n)block(e+NX,r*SY,i+n).invalidateGeometry();if(chunk(e,i-1))for(var r=0;NY>r;++r)for(var a=0;NX>a;++a)block(e+a,r*SY,i-1).invalidateGeometry();if(chunk(e,i+NZ))for(var r=0;NY>r;++r)for(var a=0;NX>a;++a)block(e+a,r*SY,i+NZ).invalidateGeometry()}function block(t,e,i){var r=coords(t,e,i);if(!r.outofbounds){var n=chunk(r.chunkx,r.chunkz);if(n)return n.blocks[r.i]}return new Block(r)}function drawScene(t,e){RENDER_STAT.start(),t.y+t.eyeHeight>=0?gl.clearColor(.5*GAME.sunlight,.8*GAME.sunlight,.98*GAME.sunlight,1):gl.clearColor(0,0,0,1),gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT);var i=t.aspectRatio||gl.viewportWidth/gl.viewportHeight;mat4.perspective(pMatrix,t.horizontalFieldOfView/i,i,.1,t.viewDistance),mat4.identity(mvMatrix),mat4.rotateX(mvMatrix,mvMatrix,t.pitch),mat4.rotateY(mvMatrix,mvMatrix,t.yaw),mat4.identity(mvMatrix),mat4.rotateX(mvMatrix,mvMatrix,t.pitch),mat4.rotateY(mvMatrix,mvMatrix,t.yaw),gl.sky.render(),mat4.identity(mvMatrix),mat4.rotateX(mvMatrix,mvMatrix,t.pitch),mat4.rotateY(mvMatrix,mvMatrix,t.yaw),mat4.translate(mvMatrix,mvMatrix,[-t.x,-t.y,-t.z]),mat4.translate(mvMatrix,mvMatrix,[0,-t.eyeHeight,0]),gl.mainShader.use(),gl.enable(gl.DEPTH_TEST),gl.activeTexture(gl.TEXTURE0),gl.bindTexture(gl.TEXTURE_2D,gl.textures.terrain),gl.uniform1i(gl.mainShader.uniforms.uSampler,0),gl.uniform1f(gl.mainShader.uniforms.uFogDistance,2*t.viewDistance/5),gl.uniform1f(gl.mainShader.uniforms.uSunlight,GAME.sunlight);var r=block(t.x,t.y+t.eyeHeight,t.z);if(r.type.translucent){var n=r.type.translucent;$("hud").style.backgroundColor="rgba("+n.join(",")+")"}else $("hud").style.backgroundColor="";$("pause").style.backgroundColor=$("hud").style.backgroundColor,gl.uniformMatrix4fv(gl.mainShader.uniforms.uPMatrix,!1,pMatrix),gl.uniformMatrix4fv(gl.mainShader.uniforms.uMVMatrix,!1,mvMatrix),gl.disable(gl.CULL_FACE);for(var a in GAME.chunks){var o=GAME.chunks[a];o.visible&&(o.opaqueBuffers.render(gl.mainShader),o.renderEntities(t))}gl.mainShader.disuse(),gl.particles.render(),gl.mainShader.use(),gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA),gl.enable(gl.BLEND),gl.enable(gl.CULL_FACE);for(var a in GAME.chunks){var o=GAME.chunks[a];o.visible&&o.translucentBuffers.render(gl.mainShader)}gl.disable(gl.BLEND),gl.disable(gl.CULL_FACE),gl.mainShader.disuse(),PICKED&&e&&gl.wireframe.render(),e&&gl.reticule.render(),RENDER_STAT.end()}function frac(t){return t-Math.floor(t)}function carf(t){return Math.ceil(t)-t}function updateWorld(){UPDATE_STAT.start();PICKED=pickp(),SPREAD_OUT&&loadNearbyChunks(AVATAR,SPREAD_OUT);for(var t in GAME.chunks){var e=GAME.chunks[t];e.hdistance=Math.max(0,hDistance(AVATAR,e.centerPoint())-CHUNK_RADIUS),e.visible=e.hdistance<AVATAR.viewDistance,e.update()}UPDATE_STAT.end()}function loadNearbyChunks(t,e,i){GAME.pendingChunks||(GAME.pendingChunks={});var r=!i;i=i||1e3;for(var n=-e;e>=n;n+=Math.min(NX,2*e))for(var a=-e;e>=a;a+=Math.min(NZ,2*e)){var o=t.x+n&~(NX-1),s=t.z+a&~(NZ-1);if(!chunk(o,s))if(r){var h=o+","+s;GAME.pendingChunks[h]||(GAME.pendingChunks[h]=!0,GAME.mapgenWorker||(GAME.mapgenWorker=new Worker("mapgen.js"),GAME.mapgenWorker.onmessage=function(t){chunk(t.data.chunkx,t.data.chunkz)||(new Chunk(t.data),GAME.pendingChunks[t.data.chunkx+","+t.data.chunkz]=!1)}),GAME.mapgenWorker.postMessage({seed:GAME.seed,chunkx:o,chunkz:s}))}else if(makeChunk(o,s),--i<=0)return!0}}function processInput(t,e){KEYS.O&&(GAME.timeOfDay=(GAME.timeOfDay+e)%(2*Math.PI),GAME.calcSunlight()),t.ddx=t.ddz=0,(KEYS.W||KEYS["&"])&&(t.ddz-=t.type.acceleration),(KEYS.A||KEYS["%"])&&(t.ddx-=t.type.acceleration),(KEYS.S||KEYS["("])&&(t.ddz+=t.type.acceleration),(KEYS.D||KEYS["'"])&&(t.ddx+=t.type.acceleration),t.ddy=0,(t.flying||t.swimming)&&(KEYS[" "]?t.ddy+=t.type.acceleration:KEYS[16]&&(t.ddy-=t.type.acceleration))}function togglePointerLock(){canvas_container.requestPointerLock&&(window.pointerLocked?document.exitPointerLock():canvas_container.requestPointerLock())}function ballistics(t,e){function i(e,i,r){for(var n=SY*Math.floor((i+d)/SY);n<i+t.height;n+=SY)if(block(e,n,r).type.solid)return!0;return d&&block(e,i,r).type.solid&&block(e,i+t.height+d,r).type.solid?!0:!1}var r={x:t.x,y:t.y,z:t.z};if(t.swimming=t.falling&&block(t).type.liquid,t.ddx||t.ddz){var n=t.type.acceleration*e,a=Math.cos(t.yaw),o=Math.sin(t.yaw);t.dx+=e*(t.ddx*a-t.ddz*o),t.dz+=e*(t.ddx*o+t.ddz*a)}else if(!t.falling){var n=(t.type.acceleration||DRAG)*e;t.dx>0&&(t.dx=Math.max(0,t.dx-n)),t.dx<0&&(t.dx=Math.min(0,t.dx+n)),t.dz>0&&(t.dz=Math.max(0,t.dz-n)),t.dz<0&&(t.dz=Math.min(0,t.dz+n))}t.ddy?t.dy+=e*t.ddy:(t.flying||t.swimming)&&(t.dy=t.dy>0?Math.max(0,t.dy-e*(t.type.acceleration||DRAG)):Math.min(0,t.dy+e*(t.type.acceleration||DRAG)));var s=sqr(t.dx)+sqr(t.dz);(t.flying||t.swimming)&&(s+=sqr(t.dy)),s=Math.sqrt(s);var h=t.flying?t.type.fly_max:t.type.walk_max;if("undefined"!=typeof h){h*=1-(block(t).type.viscosity||0);var l=s/h;l>1&&(t.dx/=l,t.dz/=l,(t.flying||t.swimming)&&(t.dy/=l))}if(t.dyaw&&(t.yaw+=e*t.dyaw),t.dpitch&&(t.pitch+=e*t.dpitch),t.dx||t.dz){{t.x,t.y,t.z}t.x+=t.dx*e,t.z+=t.dz*e;var d=t.swimming||!t.falling&&!t.flying?.5:0,u=t.type.radius||t.type.scale/2;t.dx<0&&i(t.x-u,t.y,t.z)?(t.x=Math.max(t.x,Math.floor(t.x)+u),t.dx=(t.rebound||0)*-t.dx):t.dx>0&&i(t.x+u,t.y,t.z)&&(t.x=Math.min(t.x,Math.ceil(t.x)-u),t.dx=(t.rebound||0)*-t.dx),t.dz<0&&i(t.x,t.y,t.z-u)?(t.z=Math.max(t.z,Math.floor(t.z)+u),t.dz=(t.rebound||0)*-t.dz):t.dz>0&&i(t.x,t.y,t.z+u)&&(t.z=Math.min(t.z,Math.ceil(t.z)-u),t.dz=(t.rebound||0)*-t.dz);var c=t.dx<0&&frac(t.x)<u,f=t.dx>0&&carf(t.x)>u,p=t.dz<0&&frac(t.z)<u,y=t.dz>0&&carf(t.z)>u;c&&p&&i(t.x-u,t.y,t.z-u)?frac(t.x)>frac(t.z)?t.x=Math.max(t.x,Math.floor(t.x)+u):t.z=Math.max(t.z,Math.floor(t.z)+u):c&&y&&i(t.x-u,t.y,t.z+u)?frac(t.x)>carf(t.z)?t.x=Math.max(t.x,Math.floor(t.x)+u):t.z=Math.min(t.z,Math.ceil(t.z)-u):f&&y&&i(t.x+u,t.y,t.z+u)?carf(t.x)>carf(t.z)?t.x=Math.min(t.x,Math.ceil(t.x)-u):t.z=Math.min(t.z,Math.ceil(t.z)-u):f&&p&&i(t.x+u,t.y,t.z-u)&&(carf(t.x)>frac(t.z)?t.x=Math.min(t.x,Math.ceil(t.x)-u):t.z=Math.max(t.z,Math.floor(t.z)+u))}!t.falling||t.swimming&&t.ddy||(t.dy-=GRAVITY*e),t.y+=t.dy*e;var g=block(t);g.type.solid&&(t.flying||t.falling?(t.rebound&&t.falling&&t.dy<0?(t.dy=t.rebound*-t.dy-3,t.dx/=2,t.dz/=2,t.dy<0&&(t.falling=!1,t.dy=0)):(t.flying=t.falling=!1,t.dy=0),t.y=SY*Math.floor(t.y/SY+1)):t.y=Math.min(SY*Math.floor(t.y/SY+1),t.y+5*e)),t.falling||t.flying||block(t.x,t.y-SY,t.z).type.solid||(t.falling=!0,t.y=SY*Math.floor(t.y/SY)-.001,t.dy=0),(t.flying||t.falling)&&t.dy>0&&block(t.x,t.y+t.height,t.z).type.solid&&(t.y=Math.min(t.y,SY*Math.floor((t.y+t.height)/SY)-t.height),t.dy=0),t.travelled+=distance(t,r),g.type.onstep&&g.type.onstep.call(g,t),t.y<-555&&t.die()}function pickp(){return pick(AVATAR.x,AVATAR.y+AVATAR.eyeHeight,AVATAR.z,AVATAR.pitch,AVATAR.yaw)}function pick(t,e,i,r,n){function a(t,e){return e*(0>e?Math.ceil(t-1)-t:Math.floor(t+1)-t)}function o(t){return SY*Math.ceil(t/SY-1)}function s(t){return SY*Math.floor(t/SY+1)}for(var h=-1/Math.sin(r),l=1/Math.cos(r),d=l/Math.sin(n),u=-l/Math.cos(n),c=0,f=0;3e3>f&&!(0>h?0>e:e>=HY)&&!(c>PICK_MAX);++f){var p=block(t,e,i);if(p&&!p.type.empty&&!p.type.unpickable)return p;var y=a(t,d),g=h*(0>h?o(e)-e:s(e)-e),A=a(i,u),m=1.001;y>A&&g>A?(m*=A,PICKED_FACE=u>0?0:1):y>g?(m*=g,PICKED_FACE=h>0?2:3):(m*=y,PICKED_FACE=d>0?4:5),c+=m,t+=m/d,e+=m/h,i+=m/u}return null}function tick(){requestAnimationFrame(tick);var t=wallClock(),e=t-window.lastFrame;if(FPS_STAT.add(e),window.lastFrame=t,!GAME||GAME.loading)blurryIntro.time=(blurryIntro.time||0)+e*(KEYS.S?20:1),blurryIntro(blurryIntro.time);else if("pause"!==window.mode||GAME.multiplayer){e>.1&&(e=.05),GAME.clock+=e,gl.textures.terrain.loaded&&(gl.viewport(0,0,gl.viewportWidth,gl.viewportHeight),drawScene(AVATAR,!$("hud").hide)),processInput(AVATAR,e);for(var i in GAME.chunks){var r=GAME.chunks[i];r.tick(e)}gl.particles.tick(e),t>GAME.lastUpdate+GAME.UPDATE_PERIOD&&(updateWorld(),GAME.lastUpdate=t)}$("stats").hide||($("stats").innerHTML=feedback())}function feedback(){var t=FPS_STAT+"<br>"+GEN_STAT+"<br>"+UPDATE_STAT+"<br>Player: "+AVATAR+"<br>";if(GAME&&(t+="Time: "+readableTime(GAME.timeOfDay)+" &#9788;"+GAME.sunlight.toFixed(2)),PICKED){t+="<br>Picked: "+PICKED+" @"+PICKED_FACE;var e=PICKED.neighbor(PICKED_FACE);e&&(t+=" &rarr; "+e)}var i="";for(var r in KEYS)KEYS[r]&&(i+=" "+escape(r));return i.length>0&&(t+="<br>Keys: "+i),t}function readableTime(t){var e=t<Math.PI?"am":"pm";t%=Math.PI;var i=Math.floor(12*t/Math.PI),r=Math.floor(60*(12*t/Math.PI-i));return 10>r&&(r="0"+r),0===i&&(i=12),10>i&&(i="&nbsp;"+i),i+":"+r+" "+e}function loadTexture(t,e){var i=e?gl.TEXTURE_CUBE_MAP:gl.TEXTURE_2D,r=gl.createTexture();return r.image=new Image,r.image.onload=function(){if(gl.bindTexture(i,r),gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL,!e),gl.texParameteri(i,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(i,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE),gl.texParameteri(i,gl.TEXTURE_MAG_FILTER,gl.NEAREST),gl.texParameteri(i,gl.TEXTURE_MIN_FILTER,gl.NEAREST),e){gl.texParameteri(i,gl.TEXTURE_MAG_FILTER,gl.LINEAR),gl.texParameteri(i,gl.TEXTURE_MIN_FILTER,gl.LINEAR);for(var t=[gl.TEXTURE_CUBE_MAP_NEGATIVE_Z,gl.TEXTURE_CUBE_MAP_NEGATIVE_X,gl.TEXTURE_CUBE_MAP_POSITIVE_Z,gl.TEXTURE_CUBE_MAP_POSITIVE_X,gl.TEXTURE_CUBE_MAP_NEGATIVE_Y,gl.TEXTURE_CUBE_MAP_POSITIVE_Y],n=0;6>n;++n){var a=document.createElement("canvas");a.width=r.image.height,a.height=r.image.height;var o=a.getContext("2d");o.drawImage(r.image,n*a.width,0,a.width,a.height,0,0,a.width,a.height),gl.texImage2D(t[n],0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,a)}}else gl.texImage2D(i,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,r.image);gl.bindTexture(i,null),r.loaded=!0},r.image.src=t,r}function topmost(t,e){for(var i=NY-1;i>=0;--i){var r=block(t,i*SY,e);if(r.type.solid||r.type.liquid)return r}return null}function Block(t,e){this.x=t.x,this.y=t.y,this.z=t.z,this.i=t.i,this.outofbounds=t.outofbounds,this.chunk=e,this.light=[0,0,0,t.y>=HY?LIGHT_SUN:0],this.dirtyLight=!1,this.dirtyGeometry=!1,this.type=BLOCK_TYPES.air;for(var i in t.data)this[i]=t.data[i],"type"==i&&(this.type=BLOCK_TYPES[this.type])}function changeArray(t,e){for(var i=!1,r=0;r<t.length;++r)t[r]!==e[r]&&(i=!0,t[r]=e[r]);return i}function tileCoord(t,e){var i=t.tile||t.type.tile||t.sourcetype.tile;"number"==typeof i&&(i=[i,0]);var r=0;return 4!==i.length||e!==FACE_TOP&&e!==FACE_BOTTOM?12===i.length&&"undefined"!=typeof e&&(r=2*e):r=2,{s:i[r],t:i[r+1]}}function blockGeometryHash(t){for(var e=t.vertices={aPos:[],aLighting:[],aColor:[],aTexCoord:[],indices:[]},i=(1-(t.type.scale||1))/2,r=1-i,n=t.type.scale||1,a=t.type.hashes||1,o=0;a>o;++o){var s=(.5+o)/a,h=e.aPos.length/3;e.aPos.push(t.x+i,t.y,t.z+s,t.x+r,t.y,t.z+s,t.x+r,t.y+n,t.z+s,t.x+i,t.y+n,t.z+s,t.x+s,t.y,t.z+i,t.x+s,t.y,t.z+r,t.x+s,t.y+n,t.z+r,t.x+s,t.y+n,t.z+i),e.indices.push(h+0,h+1,h+2,h+0,h+2,h+3,h+4,h+5,h+6,h+4,h+6,h+7);var l=tileCoord(t),d=1,u=d-1;d%1===0&&(d-=ZERO),u%1===0&&(u+=ZERO);for(var c=0;2>c;++c)e.aTexCoord.push(l.s+ZERO,l.t+d,l.s+ONE,l.t+d,l.s+ONE,l.t+u,l.s+ZERO,l.t+u)}for(var o=0;o<e.aPos.length/3;++o)e.aLighting.push.apply(e.aLighting,t.light||block(t).light),e.aColor.push.apply(e.aColor,t.type.color||[1,1,1]);return e}function vclamp(t){for(var e=0;e<t.length;++e)t[e]=Math.min(1,Math.max(0,t[e]));return t}function tweaker(t){return[.25*pinkNoise(t[0],t[1],t[2]+1593.1,4,1),.25*pinkNoise(t[0],t[1],t[2]+2483.7,4,1),.25*pinkNoise(t[0],t[1],t[2]+9384.3,4,1)]}function faces(t){return[[t[0],t[1],t[5],t[4]],[t[2],t[3],t[7],t[6]],[t[3],t[2],t[1],t[0]],[t[4],t[5],t[6],t[7]],[t[3],t[0],t[4],t[7]],[t[1],t[2],t[6],t[5]]]}function blockGeometryBlock(t){for(var e=t.vertices={aPos:[],aLighting:[],aColor:[],aTexCoord:[],indices:[]},i=0;6>i;++i){var r=t.neighbor(i),n=r.type.opaque;if(n=n||t.type.translucent&&t.type===r.type,!n){for(var a=e.aPos.length/3,o=_FACES[i],s=3;s>=0;--s){var h=[t.x+o[s][0],t.y+o[s][1]*SY,t.z+o[s][2]];e.aPos=e.aPos.concat(h),i===FACE_LEFT||i===FACE_RIGHT?e.aLighting.push(r.light[0]*DARKFACE,r.light[1]*DARKFACE,r.light[2]*DARKFACE,r.light[3]*DARKFACE):e.aLighting=e.aLighting.concat(r.light);var l=t.type.color||[1,1,1];e.aColor=e.aColor.concat(vclamp(vec3.add([0,0,0],l,tweaker(h))))}var d,u,c=tileCoord(t,i);i===FACE_TOP||i===FACE_BOTTOM?(d=0,u=1):t.type.stack&&"y"===AXIS[t.facing]?(d=t.type.stack-t.position-SY,u=d+SY):SY%1===0?(d=0,u=d+SY):(d=SY-frac(t.y),u=d+SY),d%1===0&&(d+=ZERO),u%1===0&&(u-=ZERO),e.aTexCoord.push(c.s+ONE,c.t+d,c.s+ZERO,c.t+d,c.s+ZERO,c.t+u,c.s+ONE,c.t+u),e.indices.push(a,a+1,a+2,a,a+2,a+3)}}}function buildTree(t){function e(t){for(var e=0;6>e;++e)if(e!=FACE_BOTTOM&&e!=FACE_TOP)for(var i=t.neighbor(e),r=0;3>r;++r,i=i.neighbor(e))i.placeBlock(BLOCK_TYPES.frond,r,e)}for(var i,r=.6,n=.2,a=7*Math.random()+3,o=0;a>o&&!t.outofbounds;++o)t.placeBlock(BLOCK_TYPES.log),i?(t.bottomSize=i.topSize,t.bottomOffset=i.topOffset):(t.bottomSize=r,t.bottomOffset=[Math.random()*(1-t.bottomSize),Math.random()*(1-t.bottomSize)]),t.topSize=r+(n-r)*(o+1)/a,t.topOffset=[Math.random()*(1-t.topSize),Math.random()*(1-t.topSize)],t.radius0=t.bottomSize/2,t.radius1=t.topSize/2,i=t,t=t.neighbor(FACE_TOP);i&&e(i)}function blockGeometryFrond(t){var e=t.vertices={aPos:[],aLighting:[],aColor:[],aTexCoord:[],indices:[]},i=t.neighbor(t.facing).type!==t.type,r=t.position-.5,n=t.facing===FACE_LEFT||t.facing===FACE_RIGHT,a=t.facing===FACE_RIGHT||t.facing===FACE_FRONT,o=n?2:0,s=n?0:2,h=tileCoord(t),l=[[9,0,8],[16,3,7],[16,2,0],[7,0,0],[0,3,1],[0,3,15],[7,0,16],[16,2,16],[16,3,9]],d=[[7,0,0],[0,3,1],[0,2,3],[2,1,11],[7,1,16],[9,1,16],[14,1,11],[16,2,3],[16,2,0]];i&&(l=d);for(var u=0;u<l.length;++u){var c=l[u][o]/16,f=l[u][s]/16;a&&(c=1-c,f=1-f);var p=(l[u][1]+2*sqr(r+l[u][2]/16))/16;e.aPos.push(t.x+c,t.y+1-p,t.z+f),e.aTexCoord.push(h.s+.01+.98*l[u][0]/16,h.t+.01+.98*l[u][2]/16),e.aLighting=e.aLighting.concat(t.light),e.aColor=e.aColor.concat(t.color||t.type.color||[1,1,1])}for(var u=1;u<l.length-1;++u)e.indices.push(0,u,u+1)}function blockGeometryLog(t){function e(t,e,i,r){return[[t-r,e,i-r],[t+r,e,i-r],[t+r,e,i+r],[t-r,e,i+r]]}t.vertices={aPos:[],aLighting:[],aColor:[],aTexCoord:[],indices:[]};var i=15,r=noise(t.x,234.567+t.y/i,t.z)%(.5-t.radius0)+.5,n=noise(t.x,234.567+(t.y+1)/i,t.z)%(.5-t.radius1)+.5,a=noise(t.x,123.456+t.y/i,t.z)%(.5-t.radius0)+.5,o=noise(t.x,123.456+(t.y+1)/i,t.z)%(.5-t.radius1)+.5,s=faces(e(r,0,a,t.radius0).concat(e(n,1,o,t.radius1)));geometryBox(t.vertices,{light:t.light,color:[1,1,1],yaw:0,pitch:0,x:t.x,y:t.y,z:t.z,tile:t.type,faces:s})}function entityGeometryHash(t,e){blockGeometryHash(t);for(var i=0;i<t.vertices.aPos.length;i+=3)t.vertices.aPos[i]-=.5,t.vertices.aPos[i+2]-=.5;appendGeometry(e,t.vertices)}function appendGeometry(t,e,i){if(t.aLighting.append(e.aLighting),!i){var r=t.aPos.length/3;t.aPos.append(e.aPos),t.aColor.append(e.aColor),t.aTexCoord.append(e.aTexCoord);for(var n=0;n<e.indices.length;++n)t.indices.push(r+e.indices[n])}}function blockGeometryBillboard(t){t.vertices={aPos:[],aLighting:[],aColor:[],aTexCoord:[],indices:[]},entityGeometryBillboard({x:t.x,y:t.y,z:t.z,type:t.type},t.vertices)}function entityGeometryBillboard(t,e){var i=e.aPos.length/3;e.aColor.push(1,1,1,1,1,1,1,1,1,1,1,1),e.indices.push(i+0,i+1,i+2,i+0,i+2,i+3);var r=block(t).light,n=[AVATAR.x-t.x,AVATAR.y+AVATAR.eyeHeight-t.y,AVATAR.z-t.z];vec3.normalize(n,n);var a=[n[2],0,-n[0]];vec3.normalize(a,a);var o=vec3.cross(vec3.create(),n,a);vec3.normalize(o,o);for(var s=t.type.scale||.25,h=[-s,-s,s,-s,s,s,-s,s],l=t.type.bob?t.type.bob*(1+Math.sin(2*t.age()))/2:0,d=[t.x,t.y+s+l,t.z],u=0;u<h.length;u+=2){for(var c=h[u],f=h[u+1],p=0;3>p;++p)e.aPos.push(c*a[p]+f*o[p]+d[p]);e.aLighting.append(r)}var y=tileCoord(t);e.aTexCoord.push(y.s+ZERO,y.t+ONE,y.s+ONE,y.t+ONE,y.s+ONE,y.t+ZERO,y.s+ZERO,y.t+ZERO)}function ppiped(t,e,i,r,n,a){return[[t,i,n],[e,i,n],[e,i,a],[t,i,a],[t,r,n],[e,r,n],[e,r,a],[t,r,a]]}function vfrustum(t,e,i,r){return[[-t,i,-t],[+t,i,-t],[+t,i,+t],[-t,i,+t],[-e,r,-e],[+e,r,-e],[+e,r,+e],[-e,r,+e]]}function geometryBox(t,e){for(var i=0;6>i;++i){for(var r=t.aPos.length/3,n=e.faces[i],a=0;4>a;++a){var o=n[a],s=Math.cos(e.yaw),h=Math.sin(e.yaw),l=o[0]*s-o[2]*h,d=o[1],u=o[0]*h+o[2]*s;t.aPos.push(e.x+l,e.y+d,e.z+u),t.aLighting=t.aLighting.concat(e.light),t.aColor=t.aColor.concat(e.color)}var c=tileCoord(e.tile,i),f=0,p=e.texheight||1;f%1===0&&(f+=ZERO),p%1===0&&(p-=ZERO),t.aTexCoord.push(c.s+ONE,c.t+p,c.s+ZERO,c.t+p,c.s+ZERO,c.t+f,c.s+ONE,c.t+f),t.indices.push(r,r+1,r+2,r,r+2,r+3)}return t}function entityGeometryBlock(t,e){var i=t.type.stack||t.sourcetype.stack||SY;t.sourcetype.faces||(t.sourcetype.faces=faces(ppiped(-t.type.radius,t.type.radius,0,i*t.type.radius*2,-t.type.radius,t.type.radius))),geometryBox(e,{light:block(t).light,color:t.type.color||t.sourcetype.color||[1,1,1],texheight:i,faces:t.sourcetype.faces,yaw:t.yaw,x:t.x,y:t.y+1/8*(1+Math.sin(2*t.age()))/2,z:t.z,tile:t})}function Wireframe(){this.shader=new Shader("wireframe");for(var t=[0,0,0,1,0,0,1,0,1,0,0,1,0,1,0,1,1,0,1,1,1,0,1,1],e=[4,5,5,6,6,7,7,4,0,1,1,2,2,3,3,0,0,4,1,5,2,6,3,7],i=1;i<t.length;i+=3)t[i]*=SY;this.aPos=makeBuffer(t,3),this.indices=makeBuffer(e,1,!1,!0)}function Reticule(){this.shader=new Shader("twodee");var t=gl.viewportWidth/2,e=gl.viewportHeight/2,i=10,r=[t-i,e,t+i,e,t,e-i,t,e+i];this.aPosition=makeBuffer(r,2)}function Skybox(t,e){this.shader=new Shader(t,e),this.buffer=makeBuffer([-1,-1,1,-1,1,1,-1,1],2)}function Entity(t,e){function i(i,n){r[i]="undefined"!=typeof t[i]?t[i]:"undefined"!=typeof e[i]?e[i]:"function"==typeof n?n():n}var r=this;t=t||{},e=e||{},i("x",0),i("y",HY),i("z",0),i("dx",0),i("dy",0),i("dz",0),i("ddx",0),i("ddy",0),i("ddz",0),i("yaw",0),i("pitch",0),i("dyaw",0),i("dpitch",0),i("travelled",0),i("birthday",GAME.clock),i("id",function(){return GAME.nextEntityID++}),i("type"),i("sourcetype",{}),"string"==typeof this.type&&(this.type=ENTITY_TYPES[this.type]),"string"==typeof this.sourcetype&&(this.sourcetype=BLOCK_TYPES[this.sourcetype]),this.height=this.type.height||this.type.scale,this.flying=this.falling=!1,this.chunk=chunk(0,0),this.chunk.entities[this.id]=this,this.type.init&&this.type.init.apply(this)}function initCamera(t){function e(e,i){"undefined"==typeof t[e]&&(t[e]=i)}e("horizontalFieldOfView",Math.PI/3),e("viewDistance",20),e("pitch",0),e("yaw",0),e("eyeHeight",0)}function takePanorama(){function t(){if(r.length>0){var n=r.pop(),a=n[0];AVATAR.pitch=n[1],AVATAR.yaw=n[2],drawScene(AVATAR);var o=new Image;o.src=canvas.toDataURL(),o.onload=function(){i.drawImage(o,256*a,0),t()}}else window.open(e.toDataURL())}var e=document.createElement("canvas");e.width=1536,e.height=256;var i=e.getContext("2d",{preserveDrawingBuffer:!0}),r=[[0,0,0],[1,0,Math.PI/2],[2,0,Math.PI],[3,0,3*Math.PI/2],[4,Math.PI/2,0],[5,-Math.PI/2,0]];t()}function onLoad(){$("throbber").innerHTML=THROBBERS[Math.floor(Math.random()*THROBBERS.length)];var t=$("canvas_container"),e=$("canvas"),i={};return initGL(e,i)?(t.requestFullscreen=t.requestFullscreen||t.mozRequestFullscreen||t.mozRequestFullScreen||t.webkitRequestFullscreen,t.requestPointerLock=t.requestPointerLock||t.mozRequestPointerLock||t.webkitRequestPointerLock,document.exitPointerLock=document.exitPointerLock||document.mozExitPointerLock||document.webkitExitPointerLock,window.pointerLockRequiresFullscreen=!!t.mozRequestPointerLock,window.addEventListener("keydown",onkeydown,!0),window.addEventListener("keyup",onkeyup,!0),window.addEventListener("mousemove",onmousemove,!0),window.addEventListener("mousedown",onmousedown,!0),window.addEventListener("focus",onfocus,!0),document.oncontextmenu=function(){return!1},document.addEventListener("fullscreenchange",fullscreenChange,!1),document.addEventListener("mozfullscreenchange",fullscreenChange,!1),document.addEventListener("webkitfullscreenchange",fullscreenChange,!1),document.addEventListener("pointerlockchange",pointerLockChange,!1),document.addEventListener("mozpointerlockchange",pointerLockChange,!1),document.addEventListener("webkitpointerlockchange",pointerLockChange,!1),document.addEventListener("pointerlockerror",pointerLockError,!1),document.addEventListener("mozpointerlockerror",pointerLockError,!1),document.addEventListener("webkitpointerlockerror",pointerLockError,!1),createInventoryUI(),void(window.location.href.indexOf("l5g")<0||($("newgame").onclick=function(){newGame(1)},$("loadgame").onclick=function(){loadGame(1)},t.requestPointerLock||failinit("<b>This browser is not supported.<br><br>Please use Chrome or Firefox.</b>"),$("resumegame2").onclick=$("resumegame").onclick=function(){togglePointerLock()},$("respawn").onclick=function(){AVATAR.dead=!1,AVATAR.dx=AVATAR.dy=AVATAR.dz=0,AVATAR.x=AVATAR.z=.5,AVATAR.y=HY;var t=topmost(AVATAR.x,AVATAR.z);t?AVATAR.y=t.y+1:AVATAR.flying=!0,AVATAR.yaw=AVATAR.pitch=0,chunk(0,0).entities[AVATAR.id]=AVATAR,togglePointerLock()},$("savegame").onclick=function(){GAME.save(function(){message("Saved."),GAME=null,AVATAR=null,showAndHideUI()})},$("quitgame").onclick=$("quitgame2").onclick=function(){GAME=null,AVATAR=null,showAndHideUI()},$("stats").hide=!0,showAndHideUI(),tick()))):void failinit("<b>This browser is not supported.<br><br>Please use Chrome or Firefox.</b>")}function newGame(t){function e(){if(r=loadNearbyChunks({x:0,z:0},SPREAD_OUT,1))setTimeout(e,0);else if(i){for(var t in GAME.chunks){var r=GAME.chunks[t];r.update(!0)}i--,setTimeout(e,0)}else new Entity({type:"player",x:NX/2-.5,y:HY/2,z:NZ/2+.5}),GAME.loading=!1,showAndHideUI()}SY=t,HY=NY*SY,GAME=new Game,GAME.loading=!0,showAndHideUI();var i=10;togglePointerLock(),makeChunk(0,0),e()}function failinit(t){$("failinit").innerHTML=t,show("failinit",!0),document.getElementById("instructions").style.display="none";for(var e=document.getElementsByTagName("button"),i=0;i<e.length;++i)e[i].style.display="none";show("title",!0)}function makeItemSlot(t){var e=document.createElement("div");e.className="toolbox";var i=document.createElement("canvas");return i.className="tool",i.id=t,i.width=i.height=48,e.appendChild(i),e}function slotClick(t){t.preventDefault();var e=t.currentTarget;if(t.ctrlKey&&HELD)e.get()||e.set({type:HELD.type,qty:0}),e.get().type===HELD.type&&(++e.get().qty,--HELD.qty<1&&(HELD=null));else if(t.ctrlKey&&e.get())HELD={type:e.get().type,qty:Math.ceil(e.get().qty/2)},e.get().qty>HELD.qty?e.get().qty-=HELD.qty:e.set(null);else if(HELD&&e.get()&&HELD.type===e.get().type)e.get().qty+=HELD.qty,HELD=null;else{var i=e.get();e.set(HELD),HELD=i}redisplayInventory(AVATAR)}function makeInventorySlot(t,e){var i=380-58*Math.floor(e/9),r=152+58*(e%9);9>e&&(i+=16);var n=makeItemSlot(t+e);n.style.left=r+"px",n.style.top=i+"px",n.get=function(){return AVATAR.inventory[e]},n.set=function(t){AVATAR.inventory[e]=t},n.position=e,"inventory"===t&&n.addEventListener("mousedown",slotClick,!1),$(t).appendChild(n)}function makeCraftingSlot(t){var e=makeItemSlot("craft"+t);e.style.left=240+58*(t%3)+"px",e.style.top=16+58*(t/3>>0)+"px",e.get=function(){return CRAFT[t]},e.set=function(e){CRAFT[t]=e},e.position=t,e.addEventListener("mousedown",slotClick,!1),$("inventory").appendChild(e)}function createInventoryUI(){$("inventory").addEventListener("mousemove",function(t){var e=$("inventory").getBoundingClientRect(),i=t.clientX-e.left,r=t.clientY-e.top,n=$("held");n.style.left=i-n.width/2+"px",n.style.top=r-n.height/2+"px"},!1);for(var t=0;36>t;++t)makeInventorySlot("inventory",t),9>t&&makeInventorySlot("hud",t);for(var t=0;9>t;++t)makeCraftingSlot(t);var e=document.createElement("div");e.innerHTML="&rarr;",e.style.position="absolute",e.style.left="414px",e.style.top="74px",e.style.fontSize="48px",$("inventory").appendChild(e);var i=makeItemSlot("crafted");i.style.left="472px",i.style.top="74px",i.addEventListener("mousedown",function(t){if(t.preventDefault(),CRAFTABLE){for(var e=0;9>e;++e)CRAFT[e]&&CRAFT[e].qty&&--CRAFT[e].qty<1&&(CRAFT[e]=null);HELD||(HELD={type:CRAFTABLE,qty:0}),++HELD.qty,redisplayInventory(AVATAR)}},!1),$("inventory").appendChild(i)}function onfocus(){GAME&&AVATAR&&drawScene(AVATAR,!0)}function onkeyup(t){onkeydown(t,0)}function onkeydown(t,e){t=t||window.event,t.preventDefault&&t.preventDefault();var i=t.keyCode,r=String.fromCharCode(i).toUpperCase();if(i>=112&&124>i&&(r="F"+(i-111)),"undefined"==typeof e&&(e=(KEYS[i]||0)+1),t.ctrlKey&&(i="^"+i,r="^"+r),KEYS[i]=KEYS[r]=e,1===e){if(("	"===r||27===i)&&(closeInventory(),togglePointerLock()),"L"===r&&canvas_container.requestFullscreen&&canvas_container.requestFullscreen(),"pause"===window.mode)return;
if(" "===r&&(GAME.clock<AVATAR.lastHop+.25?(AVATAR.flying=!AVATAR.flying,AVATAR.flying&&(AVATAR.falling=!1)):AVATAR.flying||AVATAR.falling||(AVATAR.dy=VJUMP,AVATAR.falling=!0),AVATAR.lastHop=GAME.clock),("E"===r||"I"===r)&&GAME&&!GAME.loading&&AVATAR&&(t.shiftKey?(Array.prototype.push.apply(AVATAR.inventory,AVATAR.inventory.splice(0,9)),redisplayInventory(AVATAR)):(GAME.showInventory?closeInventory():(redisplayInventory(AVATAR),GAME.showInventory=!0),togglePointerLock())),"T"===r&&GAME&&AVATAR&&!GAME.loading){var n=AVATAR.inventory[AVATAR.slot]&&AVATAR.inventory[AVATAR.slot].qty&&AVATAR.inventory[AVATAR.slot].type;if(n){n=BLOCK_TYPES[n]||ENTITY_TYPES[n];var a;n.isEntity||(a=n,n="block"),AVATAR.toss(new Entity({type:n,sourcetype:a})),--AVATAR.inventory[AVATAR.slot].qty,redisplayInventory(AVATAR)}}if("C"===r&&PICKED&&buildTree(PICKED.neighbor(PICKED_FACE)),"Y"===r&&GAME&&(window.showOptions?togglePointerLock():(window.showOptions=!0,window.pointerLocked?togglePointerLock():showAndHideUI())),(190===i||221===i)&&pickTool((AVATAR.slot+1)%9),(188===i||219===i)&&pickTool((AVATAR.slot+8)%9),"^S"===r&&GAME.save(function(){message("Game saved.")}),"^L"===r&&loadGame(1),"^0"===r&&(AVATAR.yaw=AVATAR.pitch=0),"F1"===r){var o=$("hud");o.hide=!o.hide,showAndHideUI()}var s=i-"1".charCodeAt(0);s>=0&&9>s&&pickTool(s)}}function tossAll(t){if(t&&t.type){var e=t.qty,i=t.type;i=BLOCK_TYPES[i]||ENTITY_TYPES[i];var r;for(i.isEntity||(r=i,i="block");e;--e)AVATAR.toss(new Entity({type:i,sourcetype:r}))}}function closeInventory(){if(GAME&&GAME.showInventory){GAME.showInventory=!1,tossAll(HELD),HELD=null;for(var t=0;9>t;++t)tossAll(CRAFT[t]),CRAFT[t]=null}}function killall(){for(var t in GAME.chunks){var e=GAME.chunks[t];for(var i in e.entities){var r=e.entities[i];"player"!==r.type.name&&r.die()}}}function renderInventoryItem(t,e){var i=t.getContext("2d");i.clearRect(0,0,t.width,t.height);var r=e&&e.qty,n=r&&e.type;if(n){n=BLOCK_TYPES[n]||ENTITY_TYPES[n];var a=tileCoord(n);if(i.drawImage($("terrain"),16*a.s,16*a.t,16,16,0,0,t.width,t.height),n.color){for(var o=i.getImageData(0,0,t.width,t.height),s=0;s<o.width*o.height;++s)o.data[4*s+0]*=n.color[0],o.data[4*s+1]*=n.color[1],o.data[4*s+2]*=n.color[2];i.putImageData(o,0,0)}r>1&&(i.fillStyle="white",i.font="12pt Verdana",i.textAlign="right",i.fillText(r,t.width-2,t.height-3)),t.title=n.name}else t.title=null}function redisplayInventory(t){"inventory"===window.mode&&renderInventoryItem($("held"),HELD);for(var e=0;e<t.inventory.length;++e){var i=$(window.mode+e);if(!i)break;renderInventoryItem(i,t.inventory[e])}if("inventory"===window.mode)for(var e=0;e<CRAFT.length;++e){var i=$("craft"+e);renderInventoryItem(i,CRAFT[e])}CRAFTABLE=matchRecipie(),renderInventoryItem($("crafted"),CRAFTABLE&&{type:CRAFTABLE,qty:1})}function onmousemove(t){if(window.pointerLocked&&GAME&&!GAME.loading){var e=t.movementX||t.mozMovementX||t.webkitMovementX||0,i=t.movementY||t.mozMovementY||t.webkitMovementY||0,r=.01;AVATAR.yaw+=e*r,AVATAR.pitch+=i*r,AVATAR.pitch=Math.max(Math.min(Math.PI/2,AVATAR.pitch),-Math.PI/2)}}function onmousedown(t){if(window.pointerLocked&&GAME&&!GAME.loading){if(t=t||window.event,t.preventDefault&&t.preventDefault(),PICKED)if(0===t.button)PICKED.breakBlock();else{var e=PICKED.neighbor(PICKED_FACE),r=AVATAR.inventory[AVATAR.slot]&&AVATAR.inventory[AVATAR.slot].qty&&AVATAR.inventory[AVATAR.slot].type;r&&(r=BLOCK_TYPES[r]||ENTITY_TYPES[r]),!e.outofbounds&&r&&(r.isEntity?new Entity({type:r,x:e.x+.5,y:e.y,z:e.z+.5}):e.placeBlock(r),--AVATAR.inventory[AVATAR.slot].qty<=0&&(AVATAR.inventory[i]=null),redisplayInventory(AVATAR))}return!1}}function Stat(t,e,i){this.name=t,this.alpha=e||.95,this.beta=i||.99,this.low=0,this.high=0,this.value=0,this.places=1}function fullscreenChange(){window.fullscreen=(document.fullscreenElement||document.webkitFullscreenElement||document.mozFullscreenElement||document.mozFullScreenElement)===canvas_container,window.pointerLockRequiresFullscreen&&window.fullscreen&&!window.pointerLocked&&togglePointerLock()}function pointerLockChange(){if(window.pointerLocked=(document.pointerLockElement||document.mozPointerLockElement||document.webkitPointerLockElement)===canvas_container,window.pointerLocked&&window.showOptions){window.showOptions=!1;for(var t=document.getElementsByName("rdist"),e=0;e<t.length;e++)t[e].checked&&(SPREAD_OUT=parseInt(t[e].value))}showAndHideUI()}function showAndHideUI(){window.mode=GAME?GAME.loading?"loading":window.pointerLocked?"hud":AVATAR.dead?"dead":GAME.showInventory?"inventory":window.showOptions?"options":"pause":"title";for(var t=0;t<_MODES.length;++t)show(_MODES[t],window.mode===_MODES[t]&&!$(window.mode).hide);if(window.mode=='pause')show('title',true);("inventory"===window.mode||"hud"===window.mode)&&redisplayInventory(AVATAR),show("stats",!$("stats").hide)}function show(t,e){$(t).style.display=e?"block":"none"}function pointerLockError(t){console.log("Error while locking pointer. "+t,t)}function tweak(){return Math.random()-.5}function ParticleSystem(){this.nextID=1,this.particles={},this.shader=new Shader("particle")}function makeBuffer(t,e,i,r){var n=gl.createBuffer(),a=i?gl.DYNAMIC_DRAW:gl.STATIC_DRAW,o=r?gl.ELEMENT_ARRAY_BUFFER:gl.ARRAY_BUFFER,s=r?Uint16Array:Float32Array;return gl.bindBuffer(o,n),gl.bufferData(o,new s(t),a),gl.bindBuffer(o,null),n.itemSize=e,n.numItems=t.length/e,n}function updateBuffer(t,e,i,r){if(!e||0===e.length)return null;var n=r?gl.ELEMENT_ARRAY_BUFFER:gl.ARRAY_BUFFER,a=r?Uint16Array:Float32Array;return!t||t.itemSize!==i||t.itemSize*t.numItems<e.length?(t=gl.createBuffer(),gl.bindBuffer(n,t),gl.bufferData(n,new a(e),gl.DYNAMIC_DRAW),t.itemSize=i,t.numItems=e.length/i):(gl.bindBuffer(n,t),gl.bufferSubData(n,0,new a(e))),gl.bindBuffer(n,null),t}function BufferSet(t){this.elementCount=0,t&&this.update(t)}function resizeCanvas(t,e){canvas.width=t,canvas.height=e;for(var i="canvas_container hud stats options".split(" "),r=0;r<i.length;++r)$(i[r]).style.width=t+"px",$(i[r]).style.height=e+"px"}function pickTool(t){AVATAR.slot=t;for(var e=0;9>e;++e)$("hud"+e).parentNode.style.borderColor=e===t?"white":"rgb(128, 128, 128)"}function sqr(t){return t*t}function Game(t){function e(e,r){i[e]=t.hasOwnProperty(e)?t[e]:r}t=t||{};var i=this;e("seed",9999999*Math.random()),e("timeOfDay",Math.PI),e("nextEntityID",1),e("clock",0),this.lastUpdate=this.clock,this.chunks={},this.calcSunlight(),this.UPDATE_PERIOD=.1}function wallClock(){return+new Date/1e3}function loadGame(t,e){prepStorage(function(){var i=DB.transaction(["games","chunks"],"readonly"),r=i.objectStore("games"),n=r.get(t);n.onsuccess=function(){if(!n.result){return void message("Load game failed!");}else {return false;};if(document.getElementById('title').style.display!='block'){togglePointerLock();}GAME=new Game(n.result),GAME.loading=!0,showAndHideUI();var t=i.objectStore("chunks");t.openCursor().onsuccess=function(t){var i=t.target.result;if(i){var r=new Chunk(i.value);r.nDirty=1,i.continue()}else GAME.loading=!1,message("Game loaded."),showAndHideUI(),e&&e()}}})}function prepStorage(t){if(DB)return void setTimeout(t,0);window.indexedDB=window.indexedDB||window.webkitIndexedDB||window.mozIndexedDB||window.msIndexedDB;var e=window.indexedDB.open("mineblock",DB_VERSION);e.onsuccess=function(e){DB=e.target.result,DB.onerror=function(t){console.log("STORAGE ERROR: "+t.target.errorCode,t)},setTimeout(t,0)},e.onupgradeneeded=function(t){var e=t.target.result;e.objectStoreNames.contains("games")&&e.deleteObjectStore("games"),e.objectStoreNames.contains("chunks")&&e.deleteObjectStore("chunks"),e.createObjectStore("games",{autoIncrement:!0}),e.createObjectStore("chunks",{keyPath:"key"})}}function saveChunk(t,e){var i=DB.transaction(["chunks"],"readwrite").objectStore("chunks"),r=i.put(t.data());r.onsuccess=e}function loadChunk(t){var e=DB.transaction(["chunks"],"readonly").objectStore("chunks"),i=e.get(t);i.onsuccess=function(){var t=i.result;if(t){console.log(t.value);var e=new Chunk(t.value);console.log(e),t.continue()}},i.onerror=function(e){console.log("ERROR LOADING",t,e)}}function makeFramebuffer(t,e,i,r){var n=gl.createFramebuffer();gl.bindFramebuffer(gl.FRAMEBUFFER,n),n.left=0,n.top=0,n.width=t,n.height=e;var a=gl.createTexture();if(gl.bindTexture(gl.TEXTURE_2D,a),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,r?gl.LINEAR_MIPMAP_NEAREST:gl.LINEAR),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,n.width,n.height,0,gl.RGBA,gl.UNSIGNED_BYTE,null),r&&gl.generateMipmap(gl.TEXTURE_2D),gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_2D,a,0),n.texture=a,i){var o=gl.createRenderbuffer();gl.bindRenderbuffer(gl.RENDERBUFFER,o),gl.renderbufferStorage(gl.RENDERBUFFER,gl.DEPTH_COMPONENT16,n.width,n.height),gl.framebufferRenderbuffer(gl.FRAMEBUFFER,gl.DEPTH_ATTACHMENT,gl.RENDERBUFFER,o)}return gl.bindTexture(gl.TEXTURE_2D,null),gl.bindRenderbuffer(gl.RENDERBUFFER,null),gl.bindFramebuffer(gl.FRAMEBUFFER,null),n}function makeFramebufferForTile(t,e,i){var r=gl.createFramebuffer();gl.bindFramebuffer(gl.FRAMEBUFFER,r),r.left=16*e+2,r.top=16*(15-i)+2,r.width=12,r.height=12,gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_2D,t,0);var n=gl.createRenderbuffer();return gl.bindRenderbuffer(gl.RENDERBUFFER,n),gl.renderbufferStorage(gl.RENDERBUFFER,gl.DEPTH_COMPONENT16,t.image.width,t.image.height),gl.framebufferRenderbuffer(gl.FRAMEBUFFER,gl.DEPTH_ATTACHMENT,gl.RENDERBUFFER,n),gl.bindRenderbuffer(gl.RENDERBUFFER,null),gl.bindFramebuffer(gl.FRAMEBUFFER,null),r}function renderToFramebuffer(t,e){gl.bindFramebuffer(gl.FRAMEBUFFER,e),gl.viewport(e.left,e.top,e.width,e.height),gl.scissor(e.left,e.top,e.width,e.height),gl.enable(gl.SCISSOR_TEST),drawScene(t),gl.bindFramebuffer(gl.FRAMEBUFFER,null),gl.disable(gl.SCISSOR_TEST)}function blurryIntro(t){if(gl){SAQ||(SAQ=makeBuffer([-1,-1,1,-1,1,1,-1,1],2)),gl.enable(gl.DEPTH_TEST),gl.viewport(0,0,gl.viewportWidth,gl.viewportHeight);var e=gl.viewportWidth/gl.viewportHeight;mat4.perspective(pMatrix,110*Math.PI/180/e,e,.1,10),mat4.identity(mvMatrix),mat4.rotateX(mvMatrix,mvMatrix,Math.cos(t/20)/10),mat4.rotateY(mvMatrix,mvMatrix,t/4/20),gl.textures.panorama.loaded&&gl.panorama.render()}}function vmult(t,e,i){i=i||Array(t.length);for(var r=0;r<t.length;++r)i[r]=t[r]*e[r];return i}function center(t){return{x:t.x,y:t.y+(t.height||SY)/2,z:t.z}}function frnd(t){return Math.random()*t}function rndr(t,e){return Math.random()*(e-t)+t}function rnd(t){return Math.floor(Math.random()*(t+1))}function Sound(t){var e=this,i=t;"string"==typeof i&&(i=new Knobs,i[t]()),this.init(i),_AUDIO_CONTEXT||(_AUDIO_CONTEXT=new AudioContext);var r=_AUDIO_CONTEXT.createScriptProcessor(4096,0,1);r.connect(_AUDIO_CONTEXT.destination),r.onaudioprocess=function(t){e.done&&r.disconnect(),e.generate(t.outputBuffer.getChannelData(0))},this.node=r,this.knobs=i}function Knobs(t){t=t||{};for(var e in defaultKnobs)this[e]=defaultKnobs[e];t.init&&this[t.init]();for(var e in defaultKnobs)t.hasOwnProperty(e)&&(this[e]=t[e])}function message(){var t=document.createElement("div");m=arguments[0];for(var e=1;e<arguments.length;++e)m+=arguments[e];t.innerText="> "+m,$("chat").appendChild(t),$("chat").hider=setTimeout(function(){t.style.display="none"},5e3),$("chat").scrollTop=$("chat").scrollHeight}for(var permutation=[151,160,137,91,90,15,131,13,201,95,96,53,194,233,7,225,140,36,103,30,69,142,8,99,37,240,21,10,23,190,6,148,247,120,234,75,0,26,197,62,94,252,219,203,117,35,11,32,57,177,33,88,237,149,56,87,174,20,125,136,171,168,68,175,74,165,71,134,139,48,27,166,77,146,158,231,83,111,229,122,60,211,133,230,220,105,92,41,55,46,245,40,244,102,143,54,65,25,63,161,1,216,80,73,209,76,132,187,208,89,18,169,200,196,135,130,116,188,159,86,164,100,109,198,173,186,3,64,52,217,226,250,124,123,5,202,38,147,118,126,255,82,85,212,207,206,59,227,47,16,58,17,182,189,28,42,223,183,170,213,119,248,152,2,44,154,163,70,221,153,101,155,167,43,172,9,129,22,39,253,19,98,108,110,79,113,224,232,178,185,112,104,218,246,97,228,251,34,242,193,238,210,144,12,191,179,162,241,81,51,145,235,249,14,239,107,49,192,214,31,181,199,106,157,184,84,204,176,115,121,50,45,127,4,150,254,138,236,205,93,222,114,67,29,24,72,243,141,128,195,78,66,215,61,156,180],p=new Array(512),i=0;256>i;++i)p[i+256]=p[i]=permutation[i];if("undefined"!=typeof exports){exports.noise=noise,exports.pinkNoise=pinkNoise;for(var st=+new Date,g=0,i=0;1e5>i;++i)g+=pinkNoise(823.2*i,27.533*i,2982.02*i,64,2);var e=+new Date-st;require("assert").equal(g,8.171890399128474),require("util").puts(e/1e3+" sec")}var LOGNX=4,LOGNY=5,LOGNZ=4,NX=1<<LOGNX,NY=1<<LOGNY,NZ=1<<LOGNZ,CHUNK_RADIUS=Math.sqrt(NX*NX+NZ*NZ),SY=1,HY=NY*SY,LIGHT_SUN=6,GRASSY=!1,BLOCK_TYPES={air:{tile:0,empty:!0,opaque:!1},rock:{tile:1,solid:!0,opaque:!0},"ruby ore":{tile:[6,3],solid:!0,opaque:!0,drop:"ruby"},dirt:{tile:1,color:[233/255,107/255,0],solid:!0,opaque:!0,plantable:!0},grass:{tile:[1,1],color:[.1,.6,0],solid:!0,opaque:!0,plantable:!0,update:function(){this.neighbor(FACE_TOP).type.opaque&&this.placeBlock(BLOCK_TYPES.dirt)}},flag:{tile:4,solid:!0,opaque:!0,stack:1},testpattern:{tile:5,solid:!0,opaque:!0},bedrock:{tile:6,solid:!0,opaque:!0},ice:{tile:7,solid:!0,translucent:[36,205,205,.5]},flower:{tile:8,hashes:1,scale:.6,upon:"plantable"},grassy:{tile:[4,2],hashes:2,height:.5},soybeans:{tile:[7,2],hashes:2,upon:"plantable",drop:"soybean"},weeds:{tile:[11,2],hashes:3,upon:"plantable",onstep:function(t){t.type===ENTITY_TYPES.player&&(!this.lastSpawn||this.lastSpawn+60<GAME.clock)&&(new Entity({type:"chumpa",x:this.x+1-frac(t.x),y:this.y,z:this.z+1-frac(t.z)}),this.lastSpawn=GAME.clock)}},lamp:{tile:9,hashes:1,luminosity:[8,2,2],scale:.6,upon:"solid"},candy:{tile:10,solid:!0,opaque:!0},"grape jelly":{tile:14,liquid:!0,translucent:[154,40,155,.85],viscosity:.85},"strawberry jelly":{tile:13,liquid:!0,translucent:[200,81,83,.85],viscosity:.85},"apricot jelly":{tile:15,liquid:!0,translucent:[191,124,66,.85],viscosity:.85},water:{tile:[6,2],liquid:!0,translucent:[30,137,157,.5],viscosity:.5,unpickable:!0},"miso soup":{tile:[10,2],liquid:!0,translucent:[174,154,112,.85],viscosity:.5,unpickable:!0},rope:{tile:[1,2],liquid:!0,hashes:1,update:function(){this.tile=[this.neighbor(FACE_BOTTOM).type===this.type?0:1,2];var t=this.neighbor(FACE_TOP).type;t.solid||t===this.type||this.breakBlock()},afterPlacement:function(){var t=this.neighbor(FACE_BOTTOM),e=t.neighbor(FACE_BOTTOM);!e.outofbounds&&t.type.empty&&e.type.empty&&t.placeBlock(this.type)}},mystery:{tile:[2,2,2,1],opaque:!0,solid:!0,stack:1},hal9000:{tile:[3,2,3,1],opaque:!0,solid:!0,stack:1,update:function(){this.horizontalFieldOfView||initCamera(this),this.framebuffer||(this.framebuffer=makeFramebufferForTile(gl.textures.terrain,2,2)),renderToFramebuffer(this,this.framebuffer)}},obelisk:{tile:[5,1],stack:2,solid:!0,opaque:!0},log:{tile:[4,3,4,4],solid:!0,geometry:"log"},frond:{tile:[5,3],geometry:"frond"}};for(var i in BLOCK_TYPES)BLOCK_TYPES[i].name=i;"undefined"!=typeof importScripts&&(importScripts("perlin.js"),self.onmessage=function(t){var e=generateChunk(t.data.seed,t.data.chunkx,t.data.chunkz);postMessage(e)}),document.addEventListener("DOMContentLoaded",onLoad,!1);var gl;try{var mvMatrix=mat4.create()}catch(e){failinit("<b>This browser is not supported.<br><br>Please use Chrome or Firefox.</b>")}var mvMatrixStack=[],pMatrix=mat4.create(),DB,GAME,AVATAR,SPREAD_OUT=16,PICKED=null,PICKED_FACE=0,PICK_MAX=8,HELD,CRAFT=Array(9),CRAFTABLE,KEYS={},DB_VERSION="11",GEN_STAT=new Stat("Chunk-gen"),RENDER_STAT=new Stat("Render"),UPDATE_STAT=new Stat("Update"),FPS_STAT=new Stat("FPS");FPS_STAT.invert=!0;for(var GRAVITY=23,PARTICLE_GRAVITY=6.4,DRAG=20,VJUMP=7.7,DARKFACE=.5,FACE_FRONT=0,FACE_BACK=1,FACE_BOTTOM=2,FACE_TOP=3,FACE_RIGHT=4,FACE_LEFT=5,DISTANCE=[1,1,SY,SY,1,1],OPPOSITE={},AXIS={},i=0;6>i;++i)OPPOSITE[i]=1^i,AXIS[i]="zyx"[Math.floor(i/2)];var ENTITY_TYPES={player:{invisible:!0,radius:.3,height:1.8,walk_max:4.3,fly_max:10.8,acceleration:20,init:function(){AVATAR=GAME.avatar=this,initCamera(this),this.inventory=Array(36),this.lastHop=0,this.viewDistance=100;var t=1.62;this.eyeHeight=t;var e=topmost(this.x,this.z);e?this.y=e.y+1:this.flying=!0,window.panoramaMode&&(this.horizontalFieldOfView=Math.PI/2,this.aspectRatio=1),pickTool(0)},update:function(){var t=1.25*this.viewDistance;if(this.y<-t){this.y=t,GAME.seed+=1;var e=this;setTimeout(function(){e.y=t,GAME.chunks={},makeChunk(0,0),chunk(0,0).entities[AVATAR.id]=AVATAR,chunk(0,0).update()},0)}}},drone:{tile:[3,2,1,3,3,1,3,1,1,3,1,3],radius:.35,height:1,walk_max:4.3,spin_rate:2,acceleration:20,thrust:1.05*GRAVITY,init:function(){this.nextThink=0,this.eyeHeight=.75},_HEAD:faces(scale(ppiped(-.5,.5,1,2,-.5,.5),.5)),_BODY:faces(scale(vfrustum(.7,.6,0,.99),.5)),geometry:function(t,e){var i=block(t.x,t.y+t.height/2,t.z).light;geometryBox(e,{light:i,color:t.type.color||t.sourcetype.color||[1,1,1],yaw:t.yaw,pitch:t.pitch,x:t.x,y:t.y,z:t.z,tile:t,faces:t.type._HEAD});var r={tile:[1,4,1,4,2,4,1,4,1,4,1,4]};r.tile[4]=t.ddy?2:3,geometryBox(e,{light:i,color:t.type.color||t.sourcetype.color||[1,1,1],yaw:0,x:t.x,y:t.y,z:t.z,tile:r,faces:t.type._BODY})},update:function(){if(this.nextThink<GAME.clock){this.nextThink=GAME.clock+2*Math.random(),this.ddz=Math.random()<.4?-this.type.acceleration:0;var t=4*Math.random()>>0;this.dyaw=0===t?this.type.spin_rate:1===t?-this.type.spin_rate:0,Math.random()<.25?(this.ddy=1.1*GRAVITY,this.falling=!0):this.ddy=0}if(this.ddy)for(var e=0;10>e;++e)gl.particles.spawn({x0:this.x,y0:this.y,z0:this.z,dy:this.dy-2,tile:{s:2,t:3}});this.horizontalFieldOfView||initCamera(this),this.framebuffer||(this.framebuffer=makeFramebufferForTile(gl.textures.terrain,2,2)),renderToFramebuffer(this,this.framebuffer)}},block:{fly_max:20,init:function(){this.dyaw=1,hopEntity(this),this.height=2*SY*this.type.radius,this.rebound=.75,this.sourcetype===BLOCK_TYPES.grass&&(this.sourcetype=BLOCK_TYPES.dirt),this.height=2*(this.type.stack||this.sourcetype.stack||SY)*this.type.radius},collectable:!0,radius:.125},soybean:{tile:[9,2],scale:.25,fly_max:20,collectable:!0,init:function(){hopEntity(this)},billboard:!0,bob:1/8},ruby:{tile:[6,4],scale:.25,fly_max:20,collectable:!0,init:function(){hopEntity(this)},billboard:!0,bob:1/8},chumpa:{tile:11,billboard:!0,scale:.1,init:function(){this.rebound=.75,this.landed=this.birthday,this.liveliness=.25+Math.random(),hopEntity(this,1+.5*Math.random())},update:function(){this.tile=this.falling?12:11,this.falling?this.landed=GAME.clock:block(this).type===BLOCK_TYPES.weeds&&this.age()>2?this.die():this.landed+this.liveliness<GAME.clock&&hopEntity(this,1+.5*Math.random())}}};for(var i in ENTITY_TYPES)ENTITY_TYPES[i].name=i,ENTITY_TYPES[i].isEntity=!0;var RECIPIES=[{nine:"soybean",product:"miso soup"}];Shader.prototype.use=function(){gl.useProgram(this.program);for(var t in this.attributes)gl.enableVertexAttribArray(this.attributes[t])},Shader.prototype.disuse=function(){for(var t in this.attributes)gl.disableVertexAttribArray(this.attributes[t]);gl.useProgram(null)},Chunk.prototype.data=function(){for(var t={key:this.chunkx+","+this.chunkz,chunkx:this.chunkx,chunkz:this.chunkz,blocks:new Array(NX*NY*NZ),entities:{}},e=0;NX*NY*NZ>e;++e)t.blocks[e]=this.blocks[e].data();for(var e in this.entities){var i=this.entities[e];t.entities[e]=i.data()}return t},Chunk.prototype.generateBuffers=function(t){t=t&&!(this.opaqueBuffers.empty()&&this.translucentBuffers.empty());for(var e={},i={},r=0;r<this.blocks.length;++r){var n=this.blocks[r];if(!n.type.empty){n.vertices||n.buildGeometry();var a=n.type.translucent?i:e;a.indices||(a.aPos=[],a.aTexCoord=[],a.aLighting=[],a.aColor=[],a.indices=[]),appendGeometry(a,n.vertices,t)}}t?(this.opaqueBuffers.updateLight(e),this.translucentBuffers.updateLight(i)):(this.opaqueBuffers.update(e),this.translucentBuffers.update(i))},Chunk.prototype.tick=function(t){for(var e in this.entities){var i=this.entities[e];if(i.type.tick&&i.type.tick.apply(i,[i]),i.type.collectable&&i.age()>1){var r=distance(center(AVATAR),i);r<AVATAR.type.radius?(new Sound("pop"),AVATAR.gain("block"===i.type.name?i.sourcetype.name:i.type.name),redisplayInventory(AVATAR),pickTool(AVATAR.slot),i.die()):3>r&&(i.flying=!0,i.dx=AVATAR.x-i.x,i.dy=AVATAR.y+1-i.y,i.dz=AVATAR.z-i.z,i.dx*=i.type.fly_max/r,i.dy*=i.type.fly_max/r,i.dz*=i.type.fly_max/r)}ballistics(i,t)}},Chunk.prototype.updatePeriod=function(){return Math.max(GAME.UPDATE_PERIOD,2*this.hdistance/AVATAR.viewDistance)},Chunk.prototype.update=function(t){if(this.nDirty>0&&(t||GAME.clock>this.lastUpdate+this.updatePeriod())){this.nDirty=0;for(var e=0,i=0,r={},n=this.blocks.length-1;n>=0;--n){var a=this.blocks[n],o=a.x+NX*a.z;a.sheltered=!!r[o],!a.sheltered&&a.type.opaque&&(r[o]=a),a.type.upon&&!a.neighbor(FACE_BOTTOM).type[a.type.upon]&&a.breakBlock(),a.type.update&&a.type.update.apply(a),(a.dirtyLight||a.dirtyGeometry)&&(a.dirtyLight&&e++,a.dirtyGeometry&&i++,a.update())}this.lastUpdate=GAME.clock,this.generateBuffers(0===i)}else{var a=this.blocks[Math.floor(Math.random()*NX*NY*NZ)];a.type.update&&a.type.update.apply(a)}for(var n in this.entities){var s=this.entities[n];s.type.update&&s.type.update.apply(s,[s])}},Chunk.prototype.centerPoint=function(){return{x:this.chunkx+NX/2,y:HY/2,z:this.chunkz+NZ/2}},Entity.prototype.age=function(){return GAME.clock-this.birthday};var _DZ=NX*NY,_DY=NX,_DX=1;Block.prototype.neighbor=function(t){switch(t){case FACE_FRONT:return this.z-this.chunk.chunkz>0?this.chunk.blocks[this.i-_DZ]:block(this.x,this.y,this.z-1);case FACE_BACK:return this.z-this.chunk.chunkz<NZ-1?this.chunk.blocks[this.i+_DZ]:block(this.x,this.y,this.z+1);case FACE_BOTTOM:return this.y>0?this.chunk.blocks[this.i-_DY]:block(this.x,this.y-SY,this.z);case FACE_TOP:return this.y<HY-SY?this.chunk.blocks[this.i+_DY]:block(this.x,this.y+SY,this.z);case FACE_RIGHT:return this.x-this.chunk.chunkx>0?this.chunk.blocks[this.i-_DX]:block(this.x-1,this.y,this.z);case FACE_LEFT:return this.x-this.chunk.chunkx<NX-1?this.chunk.blocks[this.i+_DX]:block(this.x+1,this.y,this.z)}},Block.prototype.eachNeighbor=function(t){t(this.neighbor(FACE_FRONT),FACE_FRONT),t(this.neighbor(FACE_BACK),FACE_BACK),t(this.neighbor(FACE_BOTTOM),FACE_BOTTOM),t(this.neighbor(FACE_TOP),FACE_TOP),t(this.neighbor(FACE_RIGHT),FACE_RIGHT),t(this.neighbor(FACE_LEFT),FACE_LEFT)},Chunk.prototype.renderEntities=function(t){var e={aPos:[],aTexCoord:[],aLighting:[],aColor:[],indices:[]};for(var i in this.entities){var r=this.entities[i];r!==t&&r.buildGeometry(e)}var n=new BufferSet(e);n.render(gl.mainShader)},window.requestAnimationFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame;var BLOCK_SAVE="light dirtyLight dirtyGeometry position facing radius0 radius1".split(" ");Block.prototype.data=function(){for(var t={type:this.type.name},e=0;e<BLOCK_SAVE.length;++e){var i=BLOCK_SAVE[e];"undefined"!=typeof this[i]&&(t[i]=this[i])}return t},Block.prototype.invalidateLight=function(t){this.dirtyLight||(this.dirtyLight=!0,delete this.vertices,this.chunk&&++this.chunk.nDirty),t&&this.eachNeighbor(function(t){t.invalidateLight()})},Block.prototype.invalidateGeometry=function(t){this.dirtyGeometry||(this.dirtyLight=!0,this.dirtyGeometry=!0,this.chunk&&++this.chunk.nDirty),t&&this.eachNeighbor(function(t){t.invalidateGeometry()})},Block.prototype.update=function(){this.dirtyGeometry&&delete this.vertices,this.dirtyLight=this.dirtyGeometry=!1;var t=[0,0,0,0];if(this.type.opaque);else{if(this.type.luminosity)for(var e=0;3>e;++e)t[e]=this.type.luminosity[e];this.sheltered||(t[3]=LIGHT_SUN),this.eachNeighbor(function(e,i){for(var r=0;4>r;++r)t[r]=Math.max(t[r],e.light[r]-DISTANCE[i])})}changeArray(this.light,t)&&this.eachNeighbor(function(t){t.invalidateLight()})},Block.prototype.breakBlock=function(){if(!this.type.empty){var t=this.type,e=this.position,i=this.facing,r=tileCoord(this);if(this.type=BLOCK_TYPES.air,delete this.position,delete this.facing,this.invalidateGeometry(!0),!e){new Entity({type:t.drop||"block",x:this.x+.5,y:this.y+(this.height||SY)/2,z:this.z+.5,sourcetype:t},this)}for(var n=0;20>n;++n){gl.particles.spawn({x0:this.x+.5,y0:this.y+.5,z0:this.z+.5,tile:r})}t.stack&&(e>0&&this.neighbor(OPPOSITE[i]).breakBlock(),e+SY<t.stack&&this.neighbor(i).breakBlock())}},Block.prototype.placeBlock=function(t,e,i){this.outofbounds||("string"==typeof t&&BLOCK_TYPES[t],t.stack&&("undefined"==typeof e&&(e=0),"undefined"==typeof i&&(i=FACE_TOP)),this.type=t,this.position=e,this.facing=i,this.invalidateGeometry(!0),this.type.afterPlacement&&this.type.afterPlacement.apply(this),this.type.stack&&this.position+DISTANCE[i]<this.type.stack&&this.neighbor(i).placeBlock(t,e+DISTANCE[i],i))},Block.prototype.toString=function(){var t=this.type.name+" ["+this.x+","+this.y+","+this.z+"] &#9788;"+this.light.join(",");return"undefined"!=typeof this.position&&(t+=" #"+this.position),"undefined"!=typeof this.facing&&(t+=" ^"+this.facing),this.outofbounds&&(t+=" &#9760;"),this.sheltered&&(t+=" &#9730;"),t};var ZERO=.01,ONE=1-ZERO,_CORNERS=[[0,0,0],[1,0,0],[1,0,1],[0,0,1],[0,1,0],[1,1,0],[1,1,1],[0,1,1]],_FACES=faces(_CORNERS),_block_geometries={log:blockGeometryLog,frond:blockGeometryFrond};Block.prototype.buildGeometry=function(){this.type.empty||(this.type.geometry?_block_geometries[this.type.geometry](this):this.type.billboard?blockGeometryBillboard(this):this.type.hashes?blockGeometryHash(this):blockGeometryBlock(this))},Entity.prototype.buildGeometry=function(t){this.type.geometry?this.type.geometry(this,t):this.type.invisible||(this.type.billboard?entityGeometryBillboard(this,t):this.sourcetype.hashes?entityGeometryHash(this,t):entityGeometryBlock(this,t))},Entity.prototype.gain=function(t,e){"undefined"==typeof e&&(e=1);for(var i=0;i<this.inventory.length;++i)if(this.inventory[i]&&this.inventory[i].type===t)return this.inventory[i].qty+=e;for(var i=0;i<this.inventory.length;++i)if(!this.inventory[i]||!this.inventory[i].type)return this.inventory[i]={type:t,qty:e};message("Inventory full!")},Array.prototype.append=function(t){this.push.apply(this,t)},Wireframe.prototype.render=function(){mvPushMatrix(),mat4.translate(mvMatrix,mvMatrix,[PICKED.x,PICKED.y,PICKED.z]),this.shader.use(),gl.lineWidth(2),gl.uniformMatrix4fv(this.shader.uniforms.uPMatrix,!1,pMatrix),gl.uniformMatrix4fv(this.shader.uniforms.uMVMatrix,!1,mvMatrix),pointToAttribute(this.shader,this,"aPos"),gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,this.indices),gl.drawElements(gl.LINES,this.indices.numItems,gl.UNSIGNED_SHORT,0),gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,null),this.shader.disuse(),gl.enable(gl.DEPTH_TEST),mvPopMatrix()},Reticule.prototype.render=function(){this.shader.use(),gl.uniform2f(this.shader.uniforms.uResolution,gl.viewportWidth,gl.viewportHeight),gl.uniform4f(this.shader.uniforms.uColor,1,1,1,1),gl.lineWidth(2),gl.blendFunc(gl.ONE_MINUS_DST_COLOR,gl.ZERO),gl.enable(gl.BLEND),pointToAttribute(this.shader,this,"aPosition"),gl.drawArrays(gl.LINES,0,this.aPosition.numItems),gl.disable(gl.BLEND),this.shader.disuse()},mat4.toInverseMat3=function(t,e){var i,r=t[0],n=t[1],a=t[2],o=t[4],s=t[5],h=t[6],l=t[8],d=t[9],u=t[10],c=u*s-h*d,f=-u*o+h*l,p=d*o-s*l,y=r*c+n*f+a*p;return y?(i=1/y,e||(e=mat3.create()),e[0]=c*i,e[1]=(-u*n+a*d)*i,e[2]=(h*n-a*s)*i,e[3]=f*i,e[4]=(u*r-a*l)*i,e[5]=(-h*r+a*o)*i,e[6]=p*i,e[7]=(-d*r+n*l)*i,e[8]=(s*r-n*o)*i,e):null},Skybox.prototype.render=function(){this.shader.use(),gl.disable(gl.DEPTH_TEST),this.shader.uniforms.hasOwnProperty("uSampler")?(gl.activeTexture(gl.TEXTURE0),gl.bindTexture(gl.TEXTURE_CUBE_MAP,gl.textures.panorama),gl.uniform1i(this.shader.uniforms.uSampler,0)):gl.uniform1f(this.shader.uniforms.uTimeOfDay,GAME.timeOfDay);var t=mat4.toInverseMat3(mvMatrix),e=mat4.invert(mat4.create(),pMatrix);gl.uniformMatrix3fv(this.shader.uniforms.uInvViewRot,!1,t),gl.uniformMatrix4fv(this.shader.uniforms.uInvProj,!1,e),gl.uniform2f(this.shader.uniforms.uViewport,gl.viewportWidth,gl.viewportHeight),pointToAttribute(this.shader,{aPos:this.buffer},"aPos"),gl.drawArrays(gl.TRIANGLE_FAN,0,this.buffer.numItems),gl.enable(gl.DEPTH_TEST),this.shader.disuse()},Entity.prototype.data=function(){for(var t={},e="x y z dx dy dz yaw pitch dyaw dpitch travelled birthday id".split(" "),i=0;i<e.length;++i){var r=e[i];t[r]=this[r]}return t.type=this.type.name,t.sourcetype=this.sourcetype.name,t},Entity.prototype.die=function(){this.dead=!0,delete this.chunk.entities[this.id],this.type===ENTITY_TYPES.player&&togglePointerLock()},Entity.prototype.toString=function(){var t="["+this.x.toFixed(2)+","+this.y.toFixed(2)+","+this.z.toFixed(2)+"] ";return t+="&lt;"+this.yaw.toFixed(2)+","+this.pitch.toFixed(2)+"&gt",t+=" +["+this.dx.toFixed(2)+","+this.dy.toFixed(2)+","+this.dz.toFixed(2)+"] ",t+=this.flying?"F":this.falling?"f":"w",this.swimming&&(t+="s"),t},Entity.prototype.facing=function(){var t=Math.cos(this.pitch);return{dy:-Math.sin(this.pitch),dx:t*Math.sin(this.yaw),dz:-t*Math.cos(this.yaw)}},Entity.prototype.toss=function(t){var e=10*(1+tweak()/4),i=this.facing();t.x=this.x,t.y=this.y+this.eyeHeight,t.z=this.z,t.dx=this.dx+(1+tweak()/2)*i.dx*e,t.dy=this.dy+(1+tweak()/2)*i.dy*e,t.dz=this.dz+(1+tweak()/2)*i.dz*e,t.yaw=Math.random()*Math.PI*2},Stat.prototype.start=function(){this.startTime=+new Date},Stat.prototype.end=function(t){"undefined"==typeof t&&(t=this.startTime),this.add(+new Date-t)},Stat.prototype.add=function(t){this.value=this.alpha*this.value+(1-this.alpha)*t,this.low=t<this.low?t:this.beta*this.low+(1-this.beta)*this.value,this.high=t>this.high?t:this.beta*this.high+(1-this.beta)*this.value},Stat.prototype.toString=function(){var t=this.value,e=this.low,i=this.high;if(this.invert){t=1/t;var r=1/i;i=1/e,e=r}return this.name+": "+t.toFixed(this.places)+" ("+e.toFixed(this.places)+" "+i.toFixed(this.places)+")"};var _MODES="title,loading,dead,hud,options,inventory,pause".split(",");ParticleSystem.prototype.spawn=function(t){var e=Math.random(),i={dx:2*tweak(),dy:.5+3*Math.random(),dz:2*tweak(),x0:0,y0:0,z0:0,id:gl.particles.nextID++,birthday:GAME.clock-e,life:e+.5+Math.random()/2,tile:{s:10,t:0}};for(var r in i)"undefined"!=typeof t[r]&&(i[r]=t[r]);var n=4;return i.tile=[16*i.tile.s+Math.floor(Math.random()*(15-n)),16*i.tile.t+Math.floor(Math.random()*(15-n))],this.add(i),i},ParticleSystem.prototype.add=function(t){this.particles[t.id]=t,delete this.buffers},ParticleSystem.prototype.remove=function(t){delete this.particles[t.id],delete this.buffers},ParticleSystem.prototype.tick=function(t){for(var e in this.particles){var i=this.particles[e];i.life-=t,i.life<0&&this.remove(i)}},ParticleSystem.prototype.bounceParticle=function(t){var e=(t.dx>0?carf(t.x0):frac(t.x0))/t.dx,i=(t.dz>0?carf(t.z0):frac(t.z0))/t.dz,r=t.dy+Math.sqrt(t.dy*t.dy+2*PARTICLE_GRAVITY*frac(t.y0))/2*PARTICLE_GRAVITY,n=Math.min(e,r,i);if(n<t.life){var a=this.spawn({x0:t.x0+n*t.dx,y0:t.y0+n*t.dy-.5*PARTICLE_GRAVITY*n*n,z0:t.z0+n*t.dz,dy:t.dy-PARTICLE_GRAVITY*n,life:t.life-n,birthday:t.birthday+n});t.life-=n;var o=.5;return n===e?a.dx*=-o:n===i?a.dz*=-o:a.dy*=-o,a}},BufferSet.prototype.empty=function(){return!this.elementCount},BufferSet.prototype.update=function(t){this.aPos=updateBuffer(this.aPos,t.aPos,3),this.aTexCoord=updateBuffer(this.aTexCoord,t.aTexCoord,2),this.aLighting=updateBuffer(this.aLighting,t.aLighting,4),this.aColor=updateBuffer(this.aColor,t.aColor,3),this.indices=updateBuffer(this.indices,t.indices,1,!0),this.elementCount=t&&t.indices?t.indices.length:0},BufferSet.prototype.updateLight=function(t){this.aLighting=updateBuffer(this.aLighting,t.aLighting,4)},BufferSet.prototype.render=function(t){this.empty()||(pointToAttribute(t,this,"aPos"),pointToAttribute(t,this,"aTexCoord"),pointToAttribute(t,this,"aLighting"),pointToAttribute(t,this,"aColor"),gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,this.indices),gl.drawElements(gl.TRIANGLES,this.elementCount,gl.UNSIGNED_SHORT,0),gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,null))},ParticleSystem.prototype.render=function(){if(this.shader.use(),!this.buffers){var t=[],e=[],i=[],r=[];for(var n in this.particles){var a=this.particles[n];
t.push(a.x0,a.y0,a.z0),e.push(a.dx,a.dy,a.dz),i.push(a.birthday),r.push.apply(r,a.tile)}this.buffers={},this.buffers.aInitialPos=makeBuffer(t,3),this.buffers.aVelocity=makeBuffer(e,3),this.buffers.aBirthday=makeBuffer(i,1),this.buffers.aTexCoord=makeBuffer(r,2)}gl.uniform1f(this.shader.uniforms.uClock,parseFloat(GAME.clock)),gl.uniform1f(this.shader.uniforms.uGravity,PARTICLE_GRAVITY),gl.uniformMatrix4fv(this.shader.uniforms.uPMatrix,!1,pMatrix),gl.uniformMatrix4fv(this.shader.uniforms.uMVMatrix,!1,mvMatrix),gl.activeTexture(gl.TEXTURE0),gl.bindTexture(gl.TEXTURE_2D,gl.textures.terrain);var o=gl.getExtension("WEBKIT_EXT_texture_filter_anisotropic");o&&gl.texParameterf(gl.TEXTURE_2D,o.TEXTURE_MAX_ANISOTROPY_EXT,$("anisotropic").checked?4:1),gl.uniform1i(this.shader.uniforms.uSampler,0),pointToAttribute(this.shader,this.buffers,"aInitialPos"),pointToAttribute(this.shader,this.buffers,"aVelocity"),pointToAttribute(this.shader,this.buffers,"aBirthday"),pointToAttribute(this.shader,this.buffers,"aTexCoord"),gl.drawArrays(gl.POINTS,0,this.buffers.aInitialPos.numItems),this.shader.disuse()},Game.prototype.data=function(){return{seed:this.seed,timeOfDay:this.timeOfDay,nextEntityID:this.nextEntityID,clock:this.clock}},Game.prototype.calcSunlight=function(){this.sunlight=.5-Math.cos(this.timeOfDay)/2},window.lastFrame=wallClock(),Game.prototype.save=function(t){var e=this;prepStorage(function(){function i(){a.length>0?saveChunk(e.chunks[a.pop()],i):t()}var r=DB.transaction(["games","chunks"],"readwrite"),n=r.objectStore("games"),a=(r.objectStore("chunks"),Object.keys(e.chunks)),o=e.data(),s="undefined"==typeof GAME.id?n.add(o):n.put(o,GAME.id);s.onsuccess=i})};var SAQ,SQUARE=0,SAWTOOTH=1,SINE=2,NOISE=3,masterVolume=.2,OVERSAMPLING=8,_AUDIO_CONTEXT;Sound.prototype.initForRepeat=function(t){this.elapsedSinceRepeat=0,this.period=44100*OVERSAMPLING/t.frequency,this.periodMax=44100*OVERSAMPLING/t.frequencyMin,this.enableFrequencyCutoff=t.frequencyMin>0,this.periodMult=Math.pow(.5,t.frequencySlide/44100),this.periodMultSlide=t.frequencySlideSlide*Math.pow(2,-44101/44100)/-44100,this.dutyCycle=t.dutyCycle,this.dutyCycleSlide=t.dutyCycleSweep/(44100*OVERSAMPLING),this.arpeggioMultiplier=1/t.arpeggioFactor,this.arpeggioTime=44100*t.arpeggioDelay},Sound.prototype.init=function(t){if(this.params=t,this.t=0,this.initForRepeat(t),this.waveShape=t.shape,this.fltw=t.lowPassFrequency/(44100*OVERSAMPLING+t.lowPassFrequency),this.enableLowPassFilter=t.lowPassFrequency<44100,this.fltw_d=Math.pow(t.lowPassSweep,1/44100),this.fltdmp=9*(1-t.lowPassResonance)*(.01+this.fltw),this.flthp=t.highPassFrequency/(44100*OVERSAMPLING+t.highPassFrequency),this.flthp_d=Math.pow(t.highPassSweep,1/44100),this.vibratoSpeed=64*t.vibratoRate/44100/10,this.vibratoAmplitude=t.vibratoDepth,this.envelopeLength=[Math.floor(44100*t.attack),Math.floor(44100*t.sustain),Math.floor(44100*t.decay)],this.envelopePunch=t.punch,this.flangerOffset=44100*t.flangerOffset,this.flangerOffsetSlide=t.flangerSweep,this.repeatTime=t.retriggerRate?1/(44100*t.retriggerRate):0,this.gain=Math.sqrt(Math.pow(10,t.gain/10)),this.sampleRate=t.sampleRate,this.fltp=0,this.fltdp=0,this.fltphp=0,this.num_clipped=0,this.waveShape===NOISE){this.noise_buffer=Array(32);for(var e=0;32>e;++e)this.noise_buffer[e]=2*Math.random()-1}this.envelopeStage=0,this.envelopeElapsed=0,this.vibratoPhase=0,this.phase=0,this.ipp=0,this.flanger_buffer=Array(1024);for(var e=0;1024>e;++e)this.flanger_buffer[e]=0},Sound.prototype.generate=function(t){for(var e=0;!this.done&&e<t.length;++this.t,++e){if(0!=this.repeatTime&&++this.elapsedSinceRepeat>=this.repeatTime&&this.initForRepeat(this.params),0!=this.arpeggioTime&&this.t>=this.arpeggioTime&&(this.arpeggioTime=0,this.period*=this.arpeggioMultiplier),this.periodMult+=this.periodMultSlide,this.period*=this.periodMult,this.period>this.periodMax&&(this.period=this.periodMax,this.enableFrequencyCutoff)){this.done=!0;break}var i=this.period;this.vibratoAmplitude>0&&(this.vibratoPhase+=this.vibratoSpeed,i=this.period*(1+Math.sin(this.vibratoPhase)*this.vibratoAmplitude));var r=Math.floor(i);if(OVERSAMPLING>r&&(r=OVERSAMPLING),this.dutyCycle+=this.dutyCycleSlide,this.dutyCycle<0&&(this.dutyCycle=0),this.dutyCycle>.5&&(this.dutyCycle=.5),++this.envelopeElapsed>this.envelopeLength[this.envelopeStage]&&(this.envelopeElapsed=0,++this.envelopeStage>2)){this.done=!0;break}var n,a=this.envelopeElapsed/this.envelopeLength[this.envelopeStage];n=0===this.envelopeStage?a:1===this.envelopeStage?1+2*(1-a)*this.envelopePunch:1-a,this.flangerOffset+=this.flangerOffsetSlide;var o=Math.abs(Math.floor(this.flangerOffset));o>1023&&(o=1023),0!=this.flthp_d&&(this.flthp*=this.flthp_d,this.flthp<1e-5&&(this.flthp=1e-5),this.flthp>.1&&(this.flthp=.1));for(var s=0,h=0,l=0,d=Math.floor(44100/this.sampleRate),u=0;OVERSAMPLING>u;++u){var c=0;if(this.phase++,this.phase>=r&&(this.phase%=r,this.waveShape===NOISE))for(var f=0;32>f;++f)this.noise_buffer[f]=2*Math.random()-1;var p=this.phase/r;if(this.waveShape===SQUARE)c=p<this.dutyCycle?.5:-.5;else if(this.waveShape===SAWTOOTH)c=p<this.dutyCycle?-1+2*p/this.dutyCycle:1-2*(p-this.dutyCycle)/(1-this.dutyCycle);else if(this.waveShape===SINE)c=Math.sin(2*p*Math.PI);else{if(this.waveShape!==NOISE)throw"ERROR: Bad wave type: "+this.waveShape;c=this.noise_buffer[Math.floor(32*this.phase/r)]}var y=this.fltp;this.fltw*=this.fltw_d,this.fltw<0&&(this.fltw=0),this.fltw>.1&&(this.fltw=.1),this.enableLowPassFilter?(this.fltdp+=(c-this.fltp)*this.fltw,this.fltdp-=this.fltdp*this.fltdmp):(this.fltp=c,this.fltdp=0),this.fltp+=this.fltdp,this.fltphp+=this.fltp-y,this.fltphp-=this.fltphp*this.flthp,c=this.fltphp,this.flanger_buffer[1023&this.ipp]=c,c+=this.flanger_buffer[this.ipp-o+1024&1023],this.ipp=this.ipp+1&1023,s+=c*n}h+=s,++l>=d&&(l=0,s=h/d,h=0,s=s/OVERSAMPLING*masterVolume,s*=this.gain,(-1>s||s>1)&&++this.num_clipped,t[e]=s)}for(;e<t.length;++this.t,++e)t[e]=0};var defaultKnobs={shape:SQUARE,attack:0,sustain:.2,punch:0,decay:.2,frequency:1e3,frequencyMin:0,frequencySlide:0,frequencySlideSlide:0,vibratoDepth:0,vibratoRate:10,arpeggioFactor:1,arpeggioDelay:.1,dutyCycle:.5,dutyCycleSweep:0,retriggerRate:0,flangerOffset:0,flangerSweep:0,lowPassFrequency:44100,lowPassSweep:1,lowPassResonance:.5,highPassFrequency:0,highPassSweep:0,gain:-10,sampleRate:44100};Knobs.prototype.pickupCoin=function(){return this.frequency=rndr(568,2861),this.attack=0,this.sustain=frnd(.227),this.decay=rndr(.227,.567),this.punch=rndr(.3,.6),rnd(1)&&(this.arpeggioFactor=rndr(1.037,1.479),this.arpeggioDelay=rndr(.042,.114)),this},Knobs.prototype.laserShoot=function(){return this.shape=rnd(2),this.shape===SINE&&rnd(1)&&(this.shape=rnd(1)),0===rnd(2)?(this.frequency=rndr(321,2861),this.frequencyMin=frnd(38.8),this.frequencySlide=rndr(-27.3,-174.5)):(this.frequency=rndr(321,3532),this.frequencyMin=rndr(144,2/3*this.frequency),this.frequencySlide=rndr(-2.15,-27.27)),this.shape===SAWTOOTH&&(this.dutyCycle=0),rnd(1)?(this.dutyCycle=rndr(.25,.5),this.dutyCycleSweep=rndr(0,-3.528)):(this.dutyCycle=rndr(.05,.3),this.dutyCycleSweep=frnd(12.35)),this.attack=0,this.sustain=rndr(.02,.2),this.decay=frnd(.36),rnd(1)&&(this.punch=frnd(.3)),0===rnd(2)&&(this.flangerOffset=frnd(.001),this.flangerSweep=-frnd(.04)),rnd(1)&&(this.highPassFrequency=frnd(3204)),this},Knobs.prototype.explosion=function(){return this.shape=NOISE,rnd(1)?(this.frequency=rndr(4,224),this.frequencySlide=rndr(-.623,17.2)):(this.frequency=rndr(9,2318),this.frequencySlide=rndr(-5.1,-40.7)),0===rnd(4)&&(this.frequencySlide=0),0===rnd(2)&&(this.retriggerRate=rndr(4.5,53)),this.attack=0,this.sustain=rndr(.0227,.363),this.decay=frnd(.567),rnd(1)&&(this.flangerOffset=rndr(-.0021,.0083),this.flangerSweep=-frnd(.09)),this.punch=.2+frnd(.6),rnd(1)&&(this.vibratoDepth=frnd(.35),this.vibratoRate=frnd(24.8)),0===rnd(2)&&(this.arpeggioFactor=rndr(.135,2.358),this.arpeggioDelay=rndr(.00526,.0733)),this},Knobs.prototype.powerUp=function(){return rnd(1)?(this.shape=SAWTOOTH,this.dutyCycle=0):this.dutyCycle=rndr(.2,.5),this.frequency=rndr(145,886),rnd(1)?(this.frequencySlide=rndr(.636,79.6),this.retriggerRate=rndr(6,53)):(this.frequencySlide=rndr(.0795,9.94),rnd(1)&&(this.vibratoDepth=frnd(.35),this.vibratoRate=frnd(24.8))),this.attack=0,this.sustain=frnd(.363),this.decay=rndr(.023,.57),this},Knobs.prototype.hitHurt=function(){return this.shape=rnd(2),this.shape===SINE&&(this.shape=NOISE),this.shape===SQUARE&&(this.dutyCycle=rndr(.2,.5)),this.shape===SAWTOOTH&&(this.dutyCycle=0),this.frequency=rndr(145,2261),this.frequencySlide=rndr(-17.2,-217.9),this.attack=0,this.sustain=frnd(.023),this.decay=rndr(.023,.2),rnd(1)&&(this.highPassFrequency=frnd(3204)),this},Knobs.prototype.jump=function(){return this.shape=SQUARE,this.dutyCycle=rndr(.2,.5),this.frequency=rndr(321,1274),this.frequencySlide=rndr(.64,17.2),this.attack=0,this.sustain=rndr(.023,.36),this.decay=rndr(.023,.2),rnd(1)&&(this.highPassFrequency=frnd(3204)),rnd(1)&&(this.lowPassFrequency=rndr(2272,44100)),this},Knobs.prototype.blipSelect=function(){return this.shape=rnd(1),this.dutyCycle=this.shape===SQUARE?rndr(.2,.5):0,this.frequency=rndr(145,1274),this.attack=0,this.sustain=rndr(.023,.09),this.decay=frnd(.09),this.highPassFrequency=353,this},Knobs.prototype.pop=function(){return this.shape=SINE,this.attack=.01,this.sustain=.01,this.decay=.165,this.frequency=300,this.frequencySlide=22,this.lowPassFrequency=8829,this.highPassFrequency=16737,this},Knobs.prototype.random=function(){function t(t){return t*t*t}var e=Math.pow;return this.frequency=rnd(1)?rndr(885.5,7941.5):rndr(3.5,3532),this.frequencySlide=rndr(-633,639),this.frequency>1732&&this.frequencySlide>5&&(this.frequencySlide=-this.frequencySlide),this.frequency<145&&this.frequencySlide<-.088&&(this.frequencySlide=-this.frequencySlide),this.frequencySlideSlide=rndr(-.88,.88),this.dutyCycle=frnd(1),this.dudyCycleSweep=rndr(-17.64,17.64),this.vibratoDepth=rndr(-.5,.5),this.vibratoRate=rndr(0,69),this.attack=2.26*t(frnd(1)),this.sustain=2.26*sqr(frnd(1))+.09,this.decay=2.26*frnd(1),this.punch=.64*sqr(frnd(1)),this.attack+this.sustain+this.decay<.45&&(this.sustain+=rndr(.5,1.25),this.decay+=rndr(.5,1.25)),this.lowPassResonance=rndr(.444,.97),this.lowPassFrequency=frnd(39200),this.lowPassSweep=rndr(.012,82),this.lowPassFrequency<35&&this.lowPassSweep<.802&&(this.lowPassSweep=1-this.lowPassSweep),this.highPassFrequency=39200*e(frnd(1),5),this.highPassSweep=555718*e(rndr(-1,1),5),this.flangerOffset=.023*t(frnd(2)-1),this.flangerSweep=t(frnd(2)-1),this.retriggerRate=frnd(1378),this.arpeggioDelay=frnd(1.81),this.arpeggioFactor=rndr(.09,10),this},Knobs.prototype.tone=function(){return this.shape=SINE,this.frequency=440,this.attack=0,this.sustain=1,this.decay=0,this};var THROBBERS=["HTML5!","Flash not required!"];